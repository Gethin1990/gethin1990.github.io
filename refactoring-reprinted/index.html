<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>[转载]C#重构经典全面汇总 - Gethin</title><meta name=Description content><meta property="og:title" content="[转载]C#重构经典全面汇总"><meta property="og:description" content="1. 封装集合  概念：本文所讲的封装集合就是把集合进行封装，只提供调用端需要的接口。
正文：在很多时候，我们都不希望把一些不必要的操作暴露给调用端，只需要给它所需要的操作或数据就行，那么做法就是封装。这个重构在微软的代码库也经常遇到。比如最经典的属性对字段的封装就是一个很好的例子，那么下面我们将看到对集合的封装，如下代码所示，调用端只需要一个集合的信息，而我们则提供了一个IList的集合，大家都知道IList具有对集合的所有操作，所以这会带来很多隐患，最好的做法就是对它进行重构。
那么重构之后，我们把IList换成了IEnumerable，大家都知道只包括一个返回值为IEnumerator的GetEnumerator()方法，所以这样只能遍历取出它的值，而不能对这个集合做出改变，这正是我们所需要的结果，具体代码如下：
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35  using System.Collections.Generic; namespace LosTechies.DaysOfRefactoring.EncapsulateCollection.Before { public class Order { private List<OrderLine> _orderLines; private double _orderTotal; public IList<OrderLine> OrderLines { get { return _orderLines; } } public void AddOrderLine(OrderLine orderLine) { _orderTotal += orderLine."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.gethin.online/refactoring-reprinted/"><meta property="og:image" content="https://blog.gethin.online/logo.png"><meta property="article:published_time" content="2021-06-05T00:00:00+00:00"><meta property="article:modified_time" content="2021-09-22T10:12:22+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.gethin.online/logo.png"><meta name=twitter:title content="[转载]C#重构经典全面汇总"><meta name=twitter:description content="1. 封装集合  概念：本文所讲的封装集合就是把集合进行封装，只提供调用端需要的接口。
正文：在很多时候，我们都不希望把一些不必要的操作暴露给调用端，只需要给它所需要的操作或数据就行，那么做法就是封装。这个重构在微软的代码库也经常遇到。比如最经典的属性对字段的封装就是一个很好的例子，那么下面我们将看到对集合的封装，如下代码所示，调用端只需要一个集合的信息，而我们则提供了一个IList的集合，大家都知道IList具有对集合的所有操作，所以这会带来很多隐患，最好的做法就是对它进行重构。
那么重构之后，我们把IList换成了IEnumerable，大家都知道只包括一个返回值为IEnumerator的GetEnumerator()方法，所以这样只能遍历取出它的值，而不能对这个集合做出改变，这正是我们所需要的结果，具体代码如下：
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35  using System.Collections.Generic; namespace LosTechies.DaysOfRefactoring.EncapsulateCollection.Before { public class Order { private List<OrderLine> _orderLines; private double _orderTotal; public IList<OrderLine> OrderLines { get { return _orderLines; } } public void AddOrderLine(OrderLine orderLine) { _orderTotal += orderLine."><meta name=application-name content="Gethin"><meta name=apple-mobile-web-app-title content="Gethin"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.gethin.online/refactoring-reprinted/><link rel=prev href=https://blog.gethin.online/redis-reprinted/><link rel=next href=https://blog.gethin.online/http-status-code/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"[转载]C#重构经典全面汇总","inLanguage":"","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.gethin.online\/refactoring-reprinted\/"},"image":["https:\/\/blog.gethin.online\/images\/Apple-Devices-Preview.png"],"genre":"posts","keywords":"重构","wordcount":5776,"url":"https:\/\/blog.gethin.online\/refactoring-reprinted\/","datePublished":"2021-06-05T00:00:00+00:00","dateModified":"2021-09-22T10:12:22+08:00","publisher":{"@type":"Organization","name":"gethin","logo":"https:\/\/cdn.jsdelivr.net\/gh\/Gethin1990\/PicBed\/BlogImg\/g.PNG"},"author":{"@type":"Person","name":"Gethin"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=Gethin><span class=header-title-pre><i class="fas fa-cloud-sun"></i></span><span class=header-title-post>Cloud & Sun</span></a></div><div class=menu style=overflow:visible><div class=menu-inner><a class=menu-item href=/ title=首页><i class="fas fa-home fa-fw"></i>首页</a>
<a class=menu-item href=/categories/><i class="fas fa-th-list fa-fw"></i>分类</a>
<a class=menu-item href=/tags/><i class="fas fa-tags fa-fw"></i>标签</a>
<a class=menu-item href=/posts/ title=所有文章><i class="fas fa-archive fa-fw"></i>归档</a><div class="dropdown menu-item" style=display:inline><a class=btn href=javascript:void(0); role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><i class="fas fa-fan fa-fw"></i>分享</a><div class=dropdown-menu style=display:none><a class=dropdown-item href=/memories/><i class="fas fa-database fa-fw"></i>记忆</a>
<a class=dropdown-item href=/reveal/><i class="fas fa-arrow-alt-circle-right fa-fw"></i>展示</a>
<a class=dropdown-item href=/websites/><i class="fas fa-globe fa-fw"></i>网站</a></div></div><div class="dropdown menu-item" style=display:inline><a class=btn href=javascript:void(0); role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><i class="fas fa-door-closed fa-fw"></i>传送门</a><div class=dropdown-menu style=display:none><a class=dropdown-item href=/message-board/><i class="fas fa-comments fa-fw"></i>留言板</a>
<a class=dropdown-item href=/milestone/><i class="fas fa-monument fa-fw"></i>里程碑</a>
<a class=dropdown-item href=/links/><i class="fas fa-user-friends fa-fw"></i>友情链</a></div></div><div class="dropdown menu-item" style=display:inline><a class=btn href=javascript:void(0); role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><i class="fas fa-user-secret fa-fw"></i>关于</a><div class=dropdown-menu style=display:none><a class=dropdown-item href=/about/><i class="fas fa-address-card fa-fw"></i>关于本人</a>
<a class=dropdown-item href=/keypoint/><i class="fas fa-star fa-fw"></i>关键信息</a></div></div><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=Gethin><span class=header-title-pre><i class="fas fa-cloud-sun"></i></span><span class=header-title-post>Cloud & Sun</span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/ title=首页><i class="fas fa-home fa-fw"></i>首页</a>
<a class=menu-item href=/categories/><i class="fas fa-th-list fa-fw"></i>分类</a>
<a class=menu-item href=/tags/><i class="fas fa-tags fa-fw"></i>标签</a>
<a class=menu-item href=/posts/ title=所有文章><i class="fas fa-archive fa-fw"></i>归档</a><div class="dropdown menu-item"><a class=btn href=javascript:void(0); role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><i class="fas fa-fan fa-fw"></i>分享</a><div class="dropdown-menu dropdown-menu-mobile" style=display:none><a class=dropdown-item href=/memories/><i class="fas fa-database fa-fw"></i>记忆</a>
<a class=dropdown-item href=/reveal/><i class="fas fa-arrow-alt-circle-right fa-fw"></i>展示</a>
<a class=dropdown-item href=/websites/><i class="fas fa-globe fa-fw"></i>网站</a></div></div><div class="dropdown menu-item"><a class=btn href=javascript:void(0); role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><i class="fas fa-door-closed fa-fw"></i>传送门</a><div class="dropdown-menu dropdown-menu-mobile" style=display:none><a class=dropdown-item href=/message-board/><i class="fas fa-comments fa-fw"></i>留言板</a>
<a class=dropdown-item href=/milestone/><i class="fas fa-monument fa-fw"></i>里程碑</a>
<a class=dropdown-item href=/links/><i class="fas fa-user-friends fa-fw"></i>友情链</a></div></div><div class="dropdown menu-item"><a class=btn href=javascript:void(0); role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><i class="fas fa-user-secret fa-fw"></i>关于</a><div class="dropdown-menu dropdown-menu-mobile" style=display:none><a class=dropdown-item href=/about/><i class="fas fa-address-card fa-fw"></i>关于本人</a>
<a class=dropdown-item href=/keypoint/><i class="fas fa-star fa-fw"></i>关键信息</a></div></div><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">[转载]C#重构经典全面汇总</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://blog.gethin.online/ title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw"></i>Gethin</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%AE%97%E6%B3%95/><i class="far fa-folder fa-fw"></i>数据与算法</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2021-06-05>2021-06-05</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 5776 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 28 分钟&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/Gethin1990/PicBed/BlogImg/refactoring-reprinted-2021-06-05-19-34-07.jpg data-srcset="https://cdn.jsdelivr.net/gh/Gethin1990/PicBed/BlogImg/refactoring-reprinted-2021-06-05-19-34-07.jpg, https://cdn.jsdelivr.net/gh/Gethin1990/PicBed/BlogImg/refactoring-reprinted-2021-06-05-19-34-07.jpg 1.5x, https://cdn.jsdelivr.net/gh/Gethin1990/PicBed/BlogImg/refactoring-reprinted-2021-06-05-19-34-07.jpg 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/Gethin1990/PicBed/BlogImg/refactoring-reprinted-2021-06-05-19-34-07.jpg title=https://cdn.jsdelivr.net/gh/Gethin1990/PicBed/BlogImg/refactoring-reprinted-2021-06-05-19-34-07.jpg></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#1-封装集合>1. 封装集合</a></li><li><a href=#2-移动方法>2. 移动方法</a></li><li><a href=#3-提升方法>3. 提升方法</a></li><li><a href=#4-降低方法>4. 降低方法</a></li><li><a href=#5-提升字段>5. 提升字段</a></li><li><a href=#6-降低字段>6. 降低字段</a></li><li><a href=#7-重命名方法类参数>7. 重命名（方法，类，参数）</a></li><li><a href=#8-使用委派代替继承>8. 使用委派代替继承</a></li><li><a href=#9-提取接口>9. 提取接口</a></li><li><a href=#10-提取方法>10. 提取方法</a></li><li><a href=#11-使用策略类>11. 使用策略类</a></li><li><a href=#12-分解依赖>12. 分解依赖</a></li><li><a href=#13-提取方法对象>13. 提取方法对象</a></li><li><a href=#14-分离职责>14. 分离职责</a></li><li><a href=#15移除重复内容>15.移除重复内容</a></li><li><a href=#16-封装条件>16. 封装条件</a></li><li><a href=#17-提取父类>17. 提取父类</a></li><li><a href=#18使用条件判断代替异常>18.使用条件判断代替异常</a></li><li><a href=#19提取工厂类>19.提取工厂类</a></li><li><a href=#20提取子类>20.提取子类</a></li><li><a href=#21合并继承>21.合并继承</a></li><li><a href=#22分解方法>22.分解方法</a></li><li><a href=#23引入参数对象>23.引入参数对象</a></li><li><a href=#24分解复杂判断>24.分解复杂判断</a></li><li><a href=#25引入契约式设计>25.引入契约式设计</a></li><li><a href=#26避免双重否定>26.避免双重否定</a></li><li><a href=#27去除上帝类>27.去除上帝类</a></li><li><a href=#28为布尔方法命名>28.为布尔方法命名</a></li><li><a href=#29去除中间人对象>29.去除中间人对象</a></li><li><a href=#30尽快返回>30.尽快返回</a></li><li><a href=#31使用多态代替条件判断>31.使用多态代替条件判断</a></li></ul></li></ul></nav></div></div><div class=content id=content><h2 id=1-封装集合>1. 封装集合</h2><hr><p><strong>概念</strong>：本文所讲的封装集合就是把集合进行封装，只提供调用端需要的接口。</p><p><strong>正文</strong>：在很多时候，我们都不希望把一些不必要的操作暴露给调用端，只需要给它所需要的操作或数据就行，那么做法就是封装。这个重构在微软的代码库也经常遇到。比如最经典的属性对字段的封装就是一个很好的例子，那么下面我们将看到对集合的封装，如下代码所示，调用端只需要一个集合的信息，而我们则提供了一个IList的集合，大家都知道IList具有对集合的所有操作，所以这会带来很多隐患，最好的做法就是对它进行重构。</p><p>那么重构之后，我们把IList换成了IEnumerable，大家都知道只包括一个返回值为IEnumerator的GetEnumerator()方法，所以这样只能遍历取出它的值，而不能对这个集合做出改变，这正是我们所需要的结果，具体代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System.Collections.Generic</span><span class=p>;</span>
<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.EncapsulateCollection.Before</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Order</span>
    <span class=p>{</span>
        <span class=k>private</span> <span class=n>List</span><span class=p>&lt;</span><span class=n>OrderLine</span><span class=p>&gt;</span> <span class=n>_orderLines</span><span class=p>;</span>
        <span class=k>private</span> <span class=kt>double</span> <span class=n>_orderTotal</span><span class=p>;</span>

        <span class=k>public</span> <span class=n>IList</span><span class=p>&lt;</span><span class=n>OrderLine</span><span class=p>&gt;</span> <span class=n>OrderLines</span>
        <span class=p>{</span>
            <span class=k>get</span> <span class=p>{</span> <span class=k>return</span> <span class=n>_orderLines</span><span class=p>;</span> <span class=p>}</span>
        <span class=p>}</span>

        <span class=k>public</span> <span class=k>void</span> <span class=n>AddOrderLine</span><span class=p>(</span><span class=n>OrderLine</span> <span class=n>orderLine</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>_orderTotal</span> <span class=p>+=</span> <span class=n>orderLine</span><span class=p>.</span><span class=n>Total</span><span class=p>;</span>
            <span class=n>_orderLines</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=n>orderLine</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=k>public</span> <span class=k>void</span> <span class=n>RemoveOrderLine</span><span class=p>(</span><span class=n>OrderLine</span> <span class=n>orderLine</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>orderLine</span> <span class=p>=</span> <span class=n>_orderLines</span><span class=p>.</span><span class=n>Find</span><span class=p>(</span><span class=n>o</span> <span class=p>=&gt;</span> <span class=n>o</span> <span class=p>==</span> <span class=n>orderLine</span><span class=p>);</span>

            <span class=k>if</span> <span class=p>(</span><span class=n>orderLine</span> <span class=p>==</span> <span class=k>null</span><span class=p>)</span>
                <span class=k>return</span><span class=p>;</span>

            <span class=n>_orderTotal</span> <span class=p>-=</span> <span class=n>orderLine</span><span class=p>.</span><span class=n>Total</span><span class=p>;</span>
            <span class=n>_orderLines</span><span class=p>.</span><span class=n>Remove</span><span class=p>(</span><span class=n>orderLine</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>OrderLine</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=kt>double</span> <span class=n>Total</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System.Collections.Generic</span><span class=p>;</span>
<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.EncapsulateCollection.After</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Order</span>
    <span class=p>{</span>
        <span class=k>private</span> <span class=n>List</span><span class=p>&lt;</span><span class=n>OrderLine</span><span class=p>&gt;</span> <span class=n>_orderLines</span><span class=p>;</span>
        <span class=k>private</span> <span class=kt>double</span> <span class=n>_orderTotal</span><span class=p>;</span>

        <span class=k>public</span> <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>OrderLine</span><span class=p>&gt;</span> <span class=n>OrderLines</span>
        <span class=p>{</span>
            <span class=k>get</span> <span class=p>{</span> <span class=k>return</span> <span class=n>_orderLines</span><span class=p>;</span> <span class=p>}</span>
        <span class=p>}</span>

        <span class=k>public</span> <span class=k>void</span> <span class=n>AddOrderLine</span><span class=p>(</span><span class=n>OrderLine</span> <span class=n>orderLine</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>_orderTotal</span> <span class=p>+=</span> <span class=n>orderLine</span><span class=p>.</span><span class=n>Total</span><span class=p>;</span>
            <span class=n>_orderLines</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=n>orderLine</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=k>public</span> <span class=k>void</span> <span class=n>RemoveOrderLine</span><span class=p>(</span><span class=n>OrderLine</span> <span class=n>orderLine</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>orderLine</span> <span class=p>=</span> <span class=n>_orderLines</span><span class=p>.</span><span class=n>Find</span><span class=p>(</span><span class=n>o</span> <span class=p>=&gt;</span> <span class=n>o</span> <span class=p>==</span> <span class=n>orderLine</span><span class=p>);</span>

            <span class=k>if</span> <span class=p>(</span><span class=n>orderLine</span> <span class=p>==</span> <span class=k>null</span><span class=p>)</span>
                <span class=k>return</span><span class=p>;</span>

            <span class=n>_orderTotal</span> <span class=p>-=</span> <span class=n>orderLine</span><span class=p>.</span><span class=n>Total</span><span class=p>;</span>
            <span class=n>_orderLines</span><span class=p>.</span><span class=n>Remove</span><span class=p>(</span><span class=n>orderLine</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>OrderLine</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=kt>double</span> <span class=n>Total</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong>总结</strong>：这个例子很容易让我们想到以前系统间耦合常喜欢用数据库。每个系统都会操作数据库，并且有些系统还会对数据库的表结构或字段进行修改，那么这很容易就会造成维护的地狱，很明智的一个做法就是使用SOA来隔开这些耦合，让一些只需要数据展示的系统得到自己需要的数据即可。</p><h2 id=2-移动方法>2. 移动方法</h2><hr><p><strong>概念</strong>：本文所讲的移动方法就是方法放在合适的位置（通常指放在合适的类中）。</p><p><strong>正文</strong>：移动方法是一个很简单也很常见的重构，只要是系统就会存在很多类，那么类里面包括很多方法，如果一个方法经常被另外一个类使用（比本身的类使用还多）或者这个方法本身就不应该放在这个类里面，那么这个适合应该考虑把它移到合适的类中。代码如下：</p><p>移动以后大家可以看到BankAccount类的职责也单一，同时CalculateInterestRate也放到了经常使用且适合它的类中了，所以此重构是一个比较好的重构，能让整个代码变得更加合理。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.MoveMethod.Before</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>BankAccount</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=n>BankAccount</span><span class=p>(</span><span class=kt>int</span> <span class=n>accountAge</span><span class=p>,</span> <span class=kt>int</span> <span class=n>creditScore</span><span class=p>,</span> <span class=n>AccountInterest</span> <span class=n>accountInterest</span><span class=p>)</span> 
        <span class=p>{</span> 
            <span class=n>AccountAge</span> <span class=p>=</span> <span class=n>accountAge</span><span class=p>;</span> 
            <span class=n>CreditScore</span> <span class=p>=</span> <span class=n>creditScore</span><span class=p>;</span> 
            <span class=n>AccountInterest</span> <span class=p>=</span> <span class=n>accountInterest</span><span class=p>;</span> 
        <span class=p>}</span>

        <span class=k>public</span> <span class=kt>int</span> <span class=n>AccountAge</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
        <span class=k>public</span> <span class=kt>int</span> <span class=n>CreditScore</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
        <span class=k>public</span> <span class=n>AccountInterest</span> <span class=n>AccountInterest</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>

        <span class=k>public</span> <span class=kt>double</span> <span class=n>CalculateInterestRate</span><span class=p>()</span>
        <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>CreditScore</span> <span class=p>&gt;</span> <span class=m>800</span><span class=p>)</span>
                <span class=k>return</span> <span class=m>0.02</span><span class=p>;</span>

            <span class=k>if</span> <span class=p>(</span><span class=n>AccountAge</span> <span class=p>&gt;</span> <span class=m>10</span><span class=p>)</span>
                <span class=k>return</span> <span class=m>0.03</span><span class=p>;</span>

            <span class=k>return</span> <span class=m>0.05</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>AccountInterest</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=n>BankAccount</span> <span class=n>Account</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>

        <span class=k>public</span> <span class=n>AccountInterest</span><span class=p>(</span><span class=n>BankAccount</span> <span class=n>account</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>Account</span> <span class=p>=</span> <span class=n>account</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=k>public</span> <span class=kt>double</span> <span class=n>InterestRate</span>
        <span class=p>{</span>
            <span class=k>get</span> <span class=p>{</span> <span class=k>return</span> <span class=n>Account</span><span class=p>.</span><span class=n>CalculateInterestRate</span><span class=p>();</span> <span class=p>}</span>
        <span class=p>}</span>

        <span class=k>public</span> <span class=kt>bool</span> <span class=n>IntroductoryRate</span>
        <span class=p>{</span>
            <span class=k>get</span> <span class=p>{</span> <span class=k>return</span> <span class=n>Account</span><span class=p>.</span><span class=n>CalculateInterestRate</span><span class=p>()</span> <span class=p>&lt;</span> <span class=m>0.05</span><span class=p>;</span> <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.MoveMethod.After</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>AccountInterest</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=n>BankAccount</span> <span class=n>Account</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>

        <span class=k>public</span> <span class=n>AccountInterest</span><span class=p>(</span><span class=n>BankAccount</span> <span class=n>account</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>Account</span> <span class=p>=</span> <span class=n>account</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=k>public</span> <span class=kt>double</span> <span class=n>InterestRate</span>
        <span class=p>{</span>
            <span class=k>get</span> <span class=p>{</span> <span class=k>return</span> <span class=n>CalculateInterestRate</span><span class=p>();</span> <span class=p>}</span>
        <span class=p>}</span>

        <span class=k>public</span> <span class=kt>bool</span> <span class=n>IntroductoryRate</span>
        <span class=p>{</span>
            <span class=k>get</span> <span class=p>{</span> <span class=k>return</span> <span class=n>CalculateInterestRate</span><span class=p>()</span> <span class=p>&lt;</span> <span class=m>0.05</span><span class=p>;</span> <span class=p>}</span>
        <span class=p>}</span>

        <span class=k>public</span> <span class=kt>double</span> <span class=n>CalculateInterestRate</span><span class=p>()</span>
        <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>Account</span><span class=p>.</span><span class=n>CreditScore</span> <span class=p>&gt;</span> <span class=m>800</span><span class=p>)</span>
                <span class=k>return</span> <span class=m>0.02</span><span class=p>;</span>

            <span class=k>if</span> <span class=p>(</span><span class=n>Account</span><span class=p>.</span><span class=n>AccountAge</span> <span class=p>&gt;</span> <span class=m>10</span><span class=p>)</span>
                <span class=k>return</span> <span class=m>0.03</span><span class=p>;</span>

            <span class=k>return</span> <span class=m>0.05</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
 
<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.MoveMethod.After</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>BankAccount</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=n>BankAccount</span><span class=p>(</span><span class=kt>int</span> <span class=n>accountAge</span><span class=p>,</span> <span class=kt>int</span> <span class=n>creditScore</span><span class=p>,</span> <span class=n>AccountInterest</span> <span class=n>accountInterest</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>AccountAge</span> <span class=p>=</span> <span class=n>accountAge</span><span class=p>;</span>
            <span class=n>CreditScore</span> <span class=p>=</span> <span class=n>creditScore</span><span class=p>;</span>
            <span class=n>AccountInterest</span> <span class=p>=</span> <span class=n>accountInterest</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=k>public</span> <span class=kt>int</span> <span class=n>AccountAge</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
        <span class=k>public</span> <span class=kt>int</span> <span class=n>CreditScore</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
        <span class=k>public</span> <span class=n>AccountInterest</span> <span class=n>AccountInterest</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong>总结</strong>：这个重构法则在很多时候能让我们把代码组织的结构调整得更合理，同时也能给以后的维护带来方便。</p><h2 id=3-提升方法>3. 提升方法</h2><hr><p><strong>概念</strong>：提升方法是指将一个很多继承类都要用到的方法提升到基类中。</p><p><strong>正文</strong>：提升方法是指将一个很多继承类都要用到的方法提升到基类中，这样就能减少代码量，同时让类的结构更清晰。如下代码所示，Turn方法在子类Car和Motorcycle 都会用到，因为Vehicle 都会有这个方法，所以我们就会想到把它提到基类中。</p><p>重构后的代码如下，那么现在Car 和Motorcycle 都具有Turn这个方法，如果这个方法修改也只需要修改基类即可，所以给维护和以后的重构带来了方便。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.PullUpMethod.Before</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>abstract</span> <span class=k>class</span> <span class=nc>Vehicle</span>
    <span class=p>{</span>
        <span class=c1>// other methods
</span><span class=c1></span>    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>Car</span> <span class=p>:</span> <span class=n>Vehicle</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=k>void</span> <span class=n>Turn</span><span class=p>(</span><span class=n>Direction</span> <span class=n>direction</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=c1>// code here
</span><span class=c1></span>        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>Motorcycle</span> <span class=p>:</span> <span class=n>Vehicle</span>
    <span class=p>{</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>enum</span> <span class=n>Direction</span>
    <span class=p>{</span>
        <span class=n>Left</span><span class=p>,</span>
        <span class=n>Right</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.PullUpMethod.After</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>abstract</span> <span class=k>class</span> <span class=nc>Vehicle</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=k>void</span> <span class=n>Turn</span><span class=p>(</span><span class=n>Direction</span> <span class=n>direction</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=c1>// code here
</span><span class=c1></span>        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>Car</span> <span class=p>:</span> <span class=n>Vehicle</span>
    <span class=p>{</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>Motorcycle</span> <span class=p>:</span> <span class=n>Vehicle</span>
    <span class=p>{</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>enum</span> <span class=n>Direction</span>
    <span class=p>{</span>
        <span class=n>Left</span><span class=p>,</span>
        <span class=n>Right</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong>总结</strong>：这个重构要根据具体情况使用，如果不是每个子类都有这个方法的话，可以考虑使用接口或者其他方式。</p><h2 id=4-降低方法>4. 降低方法</h2><hr><p><strong>概念</strong>：本文中的降低方法和前篇的提升方法整好相反，也就是把个别子类使用到的方法从基类移到子类里面去。</p><p><strong>正文</strong>：如下代码所示，Animal 类中的方法Bark只有在其子类Dog 中使用，所以最好的方案就是把这个方法移到子类Dog 中。</p><p>重构后的代码如下，同时如果在父类Animal 中如果没有其他的字段或者公用方法的话，可以考虑把Bark方法做成一个接口，从而去掉Animal 类。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.PushDownMethod.Before</span>
<span class=p>{</span>    
    <span class=k>public</span> <span class=k>abstract</span> <span class=k>class</span> <span class=nc>Animal</span>
    <span class=p>{</span>        
        <span class=k>public</span> <span class=k>void</span> <span class=n>Bark</span><span class=p>()</span>
        <span class=p>{</span>            <span class=c1>// code to bark
</span><span class=c1></span>        <span class=p>}</span>
    <span class=p>}</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Dog</span> <span class=p>:</span> <span class=n>Animal</span>
    <span class=p>{</span>
    <span class=p>}</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Cat</span> <span class=p>:</span> <span class=n>Animal</span>
    <span class=p>{</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.PushDownMethod.After</span>
<span class=p>{</span>    
    <span class=k>public</span> <span class=k>abstract</span> <span class=k>class</span> <span class=nc>Animal</span>
    <span class=p>{</span>
    <span class=p>}</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Dog</span> <span class=p>:</span> <span class=n>Animal</span>
    <span class=p>{</span>        
        <span class=k>public</span> <span class=k>void</span> <span class=n>Bark</span><span class=p>()</span>
        <span class=p>{</span>            <span class=c1>// code to bark
</span><span class=c1></span>        <span class=p>}</span>
    <span class=p>}</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Cat</span> <span class=p>:</span> <span class=n>Animal</span>
    <span class=p>{</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong>总结</strong>：面向对象三大特征（继承、封装、多态）很多时候可以帮助我们，但同时也可能会造成使用过度或者使用不当，所以如何把握好设计，这个就变得至关重要。在什么时候使用继承的方式，在什么时候使用组合和聚合，接口和继承类的选择等久成了我们的重点。</p><h2 id=5-提升字段>5. 提升字段</h2><hr><p><strong>概念</strong>：本文中的提升字段和前面的提升方法颇为相似，就是把子类公用的字段提升到基类中，从而达到公用的目的。</p><p><strong>正文</strong>：如下代码所示， Account 的两个子类CheckingAccount 和SavingsAccount 都有minimumCheckingBalance 字段，所以可以考虑把这个字段提到基类中。</p><p>重构后的代码如下，这样提的前提是这些子类有一个基类或者有很多相似的字段和方法，不然为了一个字段而单独建立一个抽象类是不可取的，所以这个就需要具体权衡。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Collections.Generic</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Linq</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Text</span><span class=p>;</span>

<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.PullUpField.Before</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>abstract</span> <span class=k>class</span> <span class=nc>Account</span>
    <span class=p>{</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>CheckingAccount</span> <span class=p>:</span> <span class=n>Account</span>
    <span class=p>{</span>
        <span class=k>private</span> <span class=kt>decimal</span> <span class=n>_minimumCheckingBalance</span> <span class=p>=</span> <span class=m>5</span><span class=n>m</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>SavingsAccount</span> <span class=p>:</span> <span class=n>Account</span>
    <span class=p>{</span>
        <span class=k>private</span> <span class=kt>decimal</span> <span class=n>_minimumSavingsBalance</span> <span class=p>=</span> <span class=m>5</span><span class=n>m</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Collections.Generic</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Linq</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Text</span><span class=p>;</span>

<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.PullUpField.After</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>abstract</span> <span class=k>class</span> <span class=nc>Account</span>
    <span class=p>{</span>
        <span class=k>protected</span> <span class=kt>decimal</span> <span class=n>_minimumBalance</span> <span class=p>=</span> <span class=m>5</span><span class=n>m</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>CheckingAccount</span> <span class=p>:</span> <span class=n>Account</span>
    <span class=p>{</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>SavingsAccount</span> <span class=p>:</span> <span class=n>Account</span>
    <span class=p>{</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong>总结</strong>：这个重构的策略比较简单，同时也是比较常用的一些做法，最主要就是要注意权衡是否真的有这个必要，看这样做究竟有没有什么好处（比如只需要改一个地方，维护简便了，同时代码量也更少了等）。</p><h2 id=6-降低字段>6. 降低字段</h2><hr><p><strong>概念</strong>：本文中的降低字段和前篇的提升字段正好相反，就是把基类中只有某些少数类用到的字段降低到使用它们的子类中。</p><p><strong>正文</strong>：如下代码所示，基类Task 类中的_resolution字段只会在子类BugTask 中用到，所以就考虑把它放到BugTask 类中。</p><p>重构后的代码如下所示，这样做的好处可以简化基类，同时让其他没有使用它的子类也变得更加简单，如果这样的字段比较多的话，使用此重构也能节约一部分内存。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.PushDownField.Before</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>abstract</span> <span class=k>class</span> <span class=nc>Task</span>
    <span class=p>{</span>
        <span class=k>protected</span> <span class=kt>string</span> <span class=n>_resolution</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>BugTask</span> <span class=p>:</span> <span class=n>Task</span>
    <span class=p>{</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>FeatureTask</span> <span class=p>:</span> <span class=n>Task</span>
    <span class=p>{</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.PushDownField.After</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>abstract</span> <span class=k>class</span> <span class=nc>Task</span>
    <span class=p>{</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>BugTask</span> <span class=p>:</span> <span class=n>Task</span>
    <span class=p>{</span>
        <span class=k>private</span> <span class=kt>string</span> <span class=n>_resolution</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>FeatureTask</span> <span class=p>:</span> <span class=n>Task</span>
    <span class=p>{</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong>总结</strong>：此重构也是一个非常简单的重构，在很多时候我们都会不自觉的使用它。</p><h2 id=7-重命名方法类参数>7. 重命名（方法，类，参数）</h2><hr><p><strong>概念</strong>：本文中的改名（方法，类，参数）是指在写代码的时候对类、方法、参数、委托、事件等等元素取一个有意义的名称。</p><p><strong>正文</strong>：如下代码所示，加入一个公司建立一个员工的类，类中有一个员工名字的字段和一个按照小时计算员工收入的方法，那么下面代码的取名就显得很难理解了，所以我们会重构名称。</p><p>重构后代码如下所示，这样看起来就非常清晰，如果有新进项目组的成员，也会变得很乐意看这个代码。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.Rename.Before</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Person</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=kt>string</span> <span class=n>FN</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>

        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>ClcHrlyPR</span><span class=p>()</span>
        <span class=p>{</span>
            <span class=c1>// code to calculate hourly payrate
</span><span class=c1></span>            <span class=k>return</span> <span class=m>0</span><span class=n>m</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.Rename.After</span>
<span class=p>{</span>
    <span class=c1>// Changed the class name to Employee
</span><span class=c1></span>    <span class=k>public</span> <span class=k>class</span> <span class=nc>Employee</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=kt>string</span> <span class=n>FirstName</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>

        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>CalculateHourlyPay</span><span class=p>()</span>
        <span class=p>{</span>
            <span class=c1>// code to calculate hourly payrate
</span><span class=c1></span>            <span class=k>return</span> <span class=m>0</span><span class=n>m</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong>总结</strong>：此重构经常被广大程序员所忽视，但是带来的隐患是不可估量的，也许老板要修改功能，那我们来看这段没有重构的代码（就算是自己写的，但由于时间和项目多等关系，我们也很难理解了），然后就会变得焦头烂额。相反重构后的代码就会觉得一目了然、赏心悦目。</p><h2 id=8-使用委派代替继承>8. 使用委派代替继承</h2><hr><p><strong>概念</strong>：本文中的“使用委派代替继承”是指在根本没有父子关系的类中使用继承是不合理的，可以用委派的方式来代替。</p><p>如下代码所示，Child 和Sanitation（公共设施）是没有逻辑上的父子关系，因为小孩不可能是一个公共设施吧！所以我们为了完成这个功能可以考虑使用委派的方式。</p><p>重构后的代码如下，把Sanitation 委派到Child 类中，从而可以使用WashHands这个方法，这种方式我们经常会用到，其实IOC也使用到了这个原理，可以通过构造注入和方法注入等。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.ReplaceInheritance.Before</span>
<span class=p>{</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Sanitation</span>
    <span class=p>{</span>        
        <span class=k>public</span> <span class=kt>string</span> <span class=n>WashHands</span><span class=p>()</span>
        <span class=p>{</span>            
              <span class=k>return</span> <span class=s>&#34;Cleaned!&#34;</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Child</span> <span class=p>:</span> <span class=n>Sanitation</span>
    <span class=p>{</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.ReplaceInheritance.After</span>
<span class=p>{</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Sanitation</span>
    <span class=p>{</span>        
        <span class=k>public</span> <span class=kt>string</span> <span class=n>WashHands</span><span class=p>()</span>
        <span class=p>{</span>            
            <span class=k>return</span> <span class=s>&#34;Cleaned!&#34;</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Child</span>
    <span class=p>{</span>        
        <span class=k>private</span> <span class=n>Sanitation</span> <span class=n>Sanitation</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>        
        <span class=k>public</span> <span class=n>Child</span><span class=p>()</span>
        <span class=p>{</span>
            <span class=n>Sanitation</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Sanitation</span><span class=p>();</span>
        <span class=p>}</span>        
        <span class=k>public</span> <span class=kt>string</span> <span class=n>WashHands</span><span class=p>()</span>
        <span class=p>{</span>            
            <span class=k>return</span> <span class=n>Sanitation</span><span class=p>.</span><span class=n>WashHands</span><span class=p>();</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong>总结</strong>：这个重构是一个很好的重构，在很大程度上解决了滥用继承的情况，很多设计模式也用到了这种思想（比如桥接模式、适配器模式、策略模式等）。</p><h2 id=9-提取接口>9. 提取接口</h2><hr><p><strong>概念</strong>：本文中的“提取接口” 是指超过一个的类要使用某一个类中部分方法时，我们应该解开它们之间的依赖，让调用者使用接口，这很容易实现也可以降低代码的耦合性。</p><p><strong>正文</strong>：如下代码所示，RegistrationProcessor 类只使用到了ClassRegistration 类中的Create方法和Total 字段，所以可以考虑把他们做成接口给RegistrationProcessor 调用。</p><p>重构后的代码如下，我们提取了一个IClassRegistration 接口，同时让ClassRegistration 继承此接口，然后调用端RegistrationProcessor 就可以直接通过IClassRegistration 接口进行调用。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.ExtractInterface.Before</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>ClassRegistration</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=k>void</span> <span class=n>Create</span><span class=p>()</span>
        <span class=p>{</span>
            <span class=c1>// create registration code
</span><span class=c1></span>        <span class=p>}</span>

        <span class=k>public</span> <span class=k>void</span> <span class=n>Transfer</span><span class=p>()</span>
        <span class=p>{</span>
            <span class=c1>// class transfer code
</span><span class=c1></span>        <span class=p>}</span>

        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>Total</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>RegistrationProcessor</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>ProcessRegistration</span><span class=p>(</span><span class=n>ClassRegistration</span> <span class=n>registration</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>registration</span><span class=p>.</span><span class=n>Create</span><span class=p>();</span>
            <span class=k>return</span> <span class=n>registration</span><span class=p>.</span><span class=n>Total</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.ExtractInterface.After</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>interface</span> <span class=n>IClassRegistration</span>
    <span class=p>{</span>
        <span class=k>void</span> <span class=n>Create</span><span class=p>();</span>
        <span class=kt>decimal</span> <span class=n>Total</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>ClassRegistration</span> <span class=p>:</span> <span class=n>IClassRegistration</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=k>void</span> <span class=n>Create</span><span class=p>()</span>
        <span class=p>{</span>
            <span class=c1>// create registration code
</span><span class=c1></span>        <span class=p>}</span>

        <span class=k>public</span> <span class=k>void</span> <span class=n>Transfer</span><span class=p>()</span>
        <span class=p>{</span>
            <span class=c1>// class transfer code
</span><span class=c1></span>        <span class=p>}</span>

        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>Total</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>RegistrationProcessor</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>ProcessRegistration</span><span class=p>(</span><span class=n>IClassRegistration</span> <span class=n>registration</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>registration</span><span class=p>.</span><span class=n>Create</span><span class=p>();</span>
            <span class=k>return</span> <span class=n>registration</span><span class=p>.</span><span class=n>Total</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong>总结</strong>：这个重构策略也是一个常见的运用，很多设计模式也会在其中运用此思想（如简单工程、抽象工厂等都会通过接口来解开依赖）。</p><h2 id=10-提取方法>10. 提取方法</h2><hr><p><strong>概念</strong>：本文中的把某些计算复杂的过程按照功能提取成各个小方法，这样就可以使代码的可读性、维护性得到提高。</p><p><strong>正文</strong>：如下代码所示，CalculateGrandTotal方法里面包含了多个逻辑，第一计算subTotal的总和，第二subTotal 要循环减去discount，也就是计算Discounts，第三就是计算Tax。所以我们可以根据功能把他们拆分成三个小方法。</p><p>重构后的代码如下，然后CalculateGrandTotal方法就直接调用CalculateSubTotal、CalculateDiscounts、CalculateTax，从而是整个逻辑看起来更加清晰，并且可读性和维护性也得到了大大提高。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System.Collections.Generic</span><span class=p>;</span>
<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.ExtractMethod.Before</span>
<span class=p>{</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Receipt</span>
    <span class=p>{</span>        
        <span class=k>private</span> <span class=n>IList</span><span class=p>&lt;</span><span class=kt>decimal</span><span class=p>&gt;</span> <span class=n>Discounts</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>        
        <span class=k>private</span> <span class=n>IList</span><span class=p>&lt;</span><span class=kt>decimal</span><span class=p>&gt;</span> <span class=n>ItemTotals</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>        
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>CalculateGrandTotal</span><span class=p>()</span>
        <span class=p>{</span>            
            <span class=kt>decimal</span> <span class=n>subTotal</span> <span class=p>=</span> <span class=m>0</span><span class=n>m</span><span class=p>;</span>            
            <span class=k>foreach</span> <span class=p>(</span><span class=kt>decimal</span> <span class=n>itemTotal</span> <span class=k>in</span> <span class=n>ItemTotals</span><span class=p>)</span>
                <span class=n>subTotal</span> <span class=p>+=</span> <span class=n>itemTotal</span><span class=p>;</span>            
            <span class=k>if</span> <span class=p>(</span><span class=n>Discounts</span><span class=p>.</span><span class=n>Count</span> <span class=p>&gt;</span> <span class=m>0</span><span class=p>)</span>
            <span class=p>{</span>                
                <span class=k>foreach</span> <span class=p>(</span><span class=kt>decimal</span> <span class=n>discount</span> <span class=k>in</span> <span class=n>Discounts</span><span class=p>)</span>
                    <span class=n>subTotal</span> <span class=p>-=</span> <span class=n>discount</span><span class=p>;</span>
            <span class=p>}</span>            
            <span class=kt>decimal</span> <span class=n>tax</span> <span class=p>=</span> <span class=n>subTotal</span> <span class=p>*</span> <span class=m>0.065</span><span class=n>m</span><span class=p>;</span>
            <span class=n>subTotal</span> <span class=p>+=</span> <span class=n>tax</span><span class=p>;</span>            
            <span class=k>return</span> <span class=n>subTotal</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System.Collections.Generic</span><span class=p>;</span>
<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.ExtractMethod.After</span>
<span class=p>{</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Receipt</span>
    <span class=p>{</span>        
        <span class=k>private</span> <span class=n>IList</span><span class=p>&lt;</span><span class=kt>decimal</span><span class=p>&gt;</span> <span class=n>Discounts</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>        
        <span class=k>private</span> <span class=n>IList</span><span class=p>&lt;</span><span class=kt>decimal</span><span class=p>&gt;</span> <span class=n>ItemTotals</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>        
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>CalculateGrandTotal</span><span class=p>()</span>
        <span class=p>{</span>            
            <span class=kt>decimal</span> <span class=n>subTotal</span> <span class=p>=</span> <span class=n>CalculateSubTotal</span><span class=p>();</span>
            <span class=n>subTotal</span> <span class=p>=</span> <span class=n>CalculateDiscounts</span><span class=p>(</span><span class=n>subTotal</span><span class=p>);</span>
            <span class=n>subTotal</span> <span class=p>=</span> <span class=n>CalculateTax</span><span class=p>(</span><span class=n>subTotal</span><span class=p>);</span>            
            <span class=k>return</span> <span class=n>subTotal</span><span class=p>;</span>
        <span class=p>}</span>        
        <span class=k>private</span> <span class=kt>decimal</span> <span class=n>CalculateTax</span><span class=p>(</span><span class=kt>decimal</span> <span class=n>subTotal</span><span class=p>)</span>
        <span class=p>{</span>            
            <span class=kt>decimal</span> <span class=n>tax</span> <span class=p>=</span> <span class=n>subTotal</span> <span class=p>*</span> <span class=m>0.065</span><span class=n>m</span><span class=p>;</span>

            <span class=n>subTotal</span> <span class=p>+=</span> <span class=n>tax</span><span class=p>;</span>            
            <span class=k>return</span> <span class=n>subTotal</span><span class=p>;</span>
        <span class=p>}</span>        
        <span class=k>private</span> <span class=kt>decimal</span> <span class=n>CalculateDiscounts</span><span class=p>(</span><span class=kt>decimal</span> <span class=n>subTotal</span><span class=p>)</span>
        <span class=p>{</span>            
            <span class=k>if</span> <span class=p>(</span><span class=n>Discounts</span><span class=p>.</span><span class=n>Count</span> <span class=p>&gt;</span> <span class=m>0</span><span class=p>)</span>
            <span class=p>{</span>                
                <span class=k>foreach</span> <span class=p>(</span><span class=kt>decimal</span> <span class=n>discount</span> <span class=k>in</span> <span class=n>Discounts</span><span class=p>)</span>
                    <span class=n>subTotal</span> <span class=p>-=</span> <span class=n>discount</span><span class=p>;</span>
            <span class=p>}</span>            
            <span class=k>return</span> <span class=n>subTotal</span><span class=p>;</span>
        <span class=p>}</span>        
        <span class=k>private</span> <span class=kt>decimal</span> <span class=n>CalculateSubTotal</span><span class=p>()</span>
        <span class=p>{</span>            
            <span class=kt>decimal</span> <span class=n>subTotal</span> <span class=p>=</span> <span class=m>0</span><span class=n>m</span><span class=p>;</span>            
            <span class=k>foreach</span> <span class=p>(</span><span class=kt>decimal</span> <span class=n>itemTotal</span> <span class=k>in</span> <span class=n>ItemTotals</span><span class=p>)</span>
                <span class=n>subTotal</span> <span class=p>+=</span> <span class=n>itemTotal</span><span class=p>;</span>            
            <span class=k>return</span> <span class=n>subTotal</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span> 
</code></pre></td></tr></table></div></div><p><strong>总结</strong>：这个重构在很多公司都有一些的代码规范作为参考，比如一个类不能超过多少行代码，一个方法里面不能超过多少行代码，这在一定程度上也能使程序员把这些复杂的逻辑剥离成意义很清楚的小方法。</p><h2 id=11-使用策略类>11. 使用策略类</h2><hr><p><strong>概念</strong>：本文中的“使用策略类” 是指用设计模式中的策略模式来替换原来的switch case和if else语句，这样可以解开耦合，同时也使维护性和系统的可扩展性大大增强。</p><p><strong>正文</strong>：如下面代码所示，ClientCode 类会更加枚举State的值来调用ShippingInfo 的不同方法，但是这样就会产生很多的判断语句，如果代码量加大，类变得很大了的话，维护中改动也会变得很大，每次改动一个地方，都要对整个结构进行编译（假如是多个工程），所以我们想到了对它进行重构，剥开耦合。</p><p>重构后的代码如下所示，抽象出一个IShippingCalculation 接口，然后把ShippingInfo 类里面的GetAlaskaShippingAmount、GetNewYorkShippingAmount、GetFloridaShippingAmount三个方法分别提炼成三个类，然后继承自IShippingCalculation 接口，这样在调用的时候就可以通过IEnumerable&lt;IShippingCalculation> 来解除之前的switch case语句，这和IOC的做法颇为相似。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.SwitchToStrategy.Before</span>
<span class=p>{</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>ClientCode</span>
    <span class=p>{</span>        
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>CalculateShipping</span><span class=p>()</span>
        <span class=p>{</span>            
            <span class=n>ShippingInfo</span> <span class=n>shippingInfo</span> <span class=p>=</span> <span class=k>new</span> <span class=n>ShippingInfo</span><span class=p>();</span>            
            <span class=k>return</span> <span class=n>shippingInfo</span><span class=p>.</span><span class=n>CalculateShippingAmount</span><span class=p>(</span><span class=n>State</span><span class=p>.</span><span class=n>Alaska</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>    
    <span class=k>public</span> <span class=k>enum</span> <span class=n>State</span>
    <span class=p>{</span>
        <span class=n>Alaska</span><span class=p>,</span>
        <span class=n>NewYork</span><span class=p>,</span>
        <span class=n>Florida</span>
    <span class=p>}</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>ShippingInfo</span>
    <span class=p>{</span>        
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>CalculateShippingAmount</span><span class=p>(</span><span class=n>State</span> <span class=n>shipToState</span><span class=p>)</span>
        <span class=p>{</span>            
            <span class=k>switch</span> <span class=p>(</span><span class=n>shipToState</span><span class=p>)</span>
            <span class=p>{</span>                
                <span class=k>case</span> <span class=n>State</span><span class=p>.</span><span class=n>Alaska</span><span class=p>:</span>                    
                    <span class=k>return</span> <span class=n>GetAlaskaShippingAmount</span><span class=p>();</span>                
                <span class=k>case</span> <span class=n>State</span><span class=p>.</span><span class=n>NewYork</span><span class=p>:</span>                    
                    <span class=k>return</span> <span class=n>GetNewYorkShippingAmount</span><span class=p>();</span>                
                <span class=k>case</span> <span class=n>State</span><span class=p>.</span><span class=n>Florida</span><span class=p>:</span>                    
                    <span class=k>return</span> <span class=n>GetFloridaShippingAmount</span><span class=p>();</span>                
                <span class=k>default</span><span class=p>:</span>                    
                    <span class=k>return</span> <span class=m>0</span><span class=n>m</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>        
        <span class=k>private</span> <span class=kt>decimal</span> <span class=n>GetAlaskaShippingAmount</span><span class=p>()</span>
        <span class=p>{</span>            
            <span class=k>return</span> <span class=m>15</span><span class=n>m</span><span class=p>;</span>
        <span class=p>}</span>        
        <span class=k>private</span> <span class=kt>decimal</span> <span class=n>GetNewYorkShippingAmount</span><span class=p>()</span>
        <span class=p>{</span>           
            <span class=k>return</span> <span class=m>10</span><span class=n>m</span><span class=p>;</span>
        <span class=p>}</span>        
        <span class=k>private</span> <span class=kt>decimal</span> <span class=n>GetFloridaShippingAmount</span><span class=p>()</span>
        <span class=p>{</span>            
            <span class=k>return</span> <span class=m>3</span><span class=n>m</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Collections.Generic</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Linq</span><span class=p>;</span>
<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.SwitchToStrategy.After_WithIoC</span>
<span class=p>{</span>   
    <span class=k>public</span> <span class=k>interface</span> <span class=n>IShippingInfo</span>
    <span class=p>{</span>        
        <span class=kt>decimal</span> <span class=n>CalculateShippingAmount</span><span class=p>(</span><span class=n>State</span> <span class=n>state</span><span class=p>);</span>
    <span class=p>}</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>ClientCode</span>
    <span class=p>{</span>
<span class=na>        [Inject]</span>        
        <span class=k>public</span> <span class=n>IShippingInfo</span> <span class=n>ShippingInfo</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>        
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>CalculateShipping</span><span class=p>()</span>
        <span class=p>{</span>            
            <span class=k>return</span> <span class=n>ShippingInfo</span><span class=p>.</span><span class=n>CalculateShippingAmount</span><span class=p>(</span><span class=n>State</span><span class=p>.</span><span class=n>Alaska</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>    
    <span class=k>public</span> <span class=k>enum</span> <span class=n>State</span>
    <span class=p>{</span>
        <span class=n>Alaska</span><span class=p>,</span>
        <span class=n>NewYork</span><span class=p>,</span>
        <span class=n>Florida</span>
    <span class=p>}</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>ShippingInfo</span> <span class=p>:</span> <span class=n>IShippingInfo</span>
    <span class=p>{</span>        
        <span class=k>private</span> <span class=n>IDictionary</span><span class=p>&lt;</span><span class=n>State</span><span class=p>,</span> <span class=n>IShippingCalculation</span><span class=p>&gt;</span> <span class=n>ShippingCalculations</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>        
        <span class=k>public</span> <span class=n>ShippingInfo</span><span class=p>(</span><span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>IShippingCalculation</span><span class=p>&gt;</span> <span class=n>shippingCalculations</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>ShippingCalculations</span> <span class=p>=</span> <span class=n>shippingCalculations</span><span class=p>.</span><span class=n>ToDictionary</span><span class=p>(</span><span class=n>calc</span> <span class=p>=&gt;</span> <span class=n>calc</span><span class=p>.</span><span class=n>State</span><span class=p>);</span>
        <span class=p>}</span>        
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>CalculateShippingAmount</span><span class=p>(</span><span class=n>State</span> <span class=n>shipToState</span><span class=p>)</span>
        <span class=p>{</span>            
            <span class=k>return</span> <span class=n>ShippingCalculations</span><span class=p>[</span><span class=n>shipToState</span><span class=p>].</span><span class=n>Calculate</span><span class=p>();</span>
        <span class=p>}</span>
    <span class=p>}</span>    
    <span class=k>public</span> <span class=k>interface</span> <span class=n>IShippingCalculation</span>
    <span class=p>{</span>        
        <span class=n>State</span> <span class=n>State</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=p>}</span>        
        <span class=kt>decimal</span> <span class=n>Calculate</span><span class=p>();</span>
    <span class=p>}</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>AlaskShippingCalculation</span> <span class=p>:</span> <span class=n>IShippingCalculation</span>
    <span class=p>{</span>        
        <span class=k>public</span> <span class=n>State</span> <span class=n>State</span> <span class=p>{</span> <span class=k>get</span> <span class=p>{</span> <span class=k>return</span> <span class=n>State</span><span class=p>.</span><span class=n>Alaska</span><span class=p>;</span> <span class=p>}</span> <span class=p>}</span>        
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>Calculate</span><span class=p>()</span>
        <span class=p>{</span>            
            <span class=k>return</span> <span class=m>15</span><span class=n>m</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>NewYorkShippingCalculation</span> <span class=p>:</span> <span class=n>IShippingCalculation</span>
    <span class=p>{</span>        
        <span class=k>public</span> <span class=n>State</span> <span class=n>State</span> <span class=p>{</span> <span class=k>get</span> <span class=p>{</span> <span class=k>return</span> <span class=n>State</span><span class=p>.</span><span class=n>NewYork</span><span class=p>;</span> <span class=p>}</span> <span class=p>}</span>        
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>Calculate</span><span class=p>()</span>
        <span class=p>{</span>            
            <span class=k>return</span> <span class=m>10</span><span class=n>m</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>FloridaShippingCalculation</span> <span class=p>:</span> <span class=n>IShippingCalculation</span>
    <span class=p>{</span>        
        <span class=k>public</span> <span class=n>State</span> <span class=n>State</span> <span class=p>{</span> <span class=k>get</span> <span class=p>{</span> <span class=k>return</span> <span class=n>State</span><span class=p>.</span><span class=n>Florida</span><span class=p>;</span> <span class=p>}</span> <span class=p>}</span>        
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>Calculate</span><span class=p>()</span>
        <span class=p>{</span>            
            <span class=k>return</span> <span class=m>3</span><span class=n>m</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span> 
</code></pre></td></tr></table></div></div><p><strong>总结</strong>：这种重构在设计模式当中把它单独取了一个名字——策略模式，这样做的好处就是可以隔开耦合，以注入的形式实现功能，这使增加功能变得更加容易和简便，同样也增强了整个系统的稳定性和健壮性。</p><h2 id=12-分解依赖>12. 分解依赖</h2><hr><p><strong>概念</strong>：本文中的“分解依赖” 是指对部分不满足我们要求的类和方法进行依赖分解，通过装饰器来达到我们需要的功能。</p><p><strong>正文</strong>：正如下面代码所示，如果你要在你的代码中加入单元测试但有一部分代码是你不想测试的，那么你应用使用这个的重构。下面的例子中我们应用静态类来完成某些工作，但问题是在单元测试时我们无法mock静态类，所以我们只能引入静态类的装饰接口来分解对静态类的依赖。从而我们使我们的调用类只需要依赖于装饰接口就能完成这个操作。</p><p>重构后代码如下，我们添加一个接口和一个实现类，在实现类中调用静态类的方法，所以说具体做什么事情没有改变，改变的只是形式，但这样做的一个好处是增加了了代码的可测试性。在应用了分解依赖模式后，我们就可以在单元测试的时候mock一个IFeederService对象并通过AnimalFeedingService的构造函数传递给它。这样就可以完成我们需要的功能。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.BreakDependencies.Before</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>AnimalFeedingService</span>
    <span class=p>{</span>
        <span class=k>private</span> <span class=kt>bool</span> <span class=n>FoodBowlEmpty</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>

        <span class=k>public</span> <span class=k>void</span> <span class=n>Feed</span><span class=p>()</span>
        <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>FoodBowlEmpty</span><span class=p>)</span>
                <span class=n>Feeder</span><span class=p>.</span><span class=n>ReplenishFood</span><span class=p>();</span>

            <span class=c1>// more code to feed the animal
</span><span class=c1></span>        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>static</span> <span class=k>class</span> <span class=nc>Feeder</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=k>static</span> <span class=k>void</span> <span class=n>ReplenishFood</span><span class=p>()</span>
        <span class=p>{</span>
            <span class=c1>// fill up bowl
</span><span class=c1></span>        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.BreakDependencies.After</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>AnimalFeedingService</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=n>IFeederService</span> <span class=n>FeederService</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>

        <span class=k>public</span> <span class=n>AnimalFeedingService</span><span class=p>(</span><span class=n>IFeederService</span> <span class=n>feederService</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>FeederService</span> <span class=p>=</span> <span class=n>feederService</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=k>private</span> <span class=kt>bool</span> <span class=n>FoodBowlEmpty</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>

        <span class=k>public</span> <span class=k>void</span> <span class=n>Feed</span><span class=p>()</span>
        <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>FoodBowlEmpty</span><span class=p>)</span>
                <span class=n>FeederService</span><span class=p>.</span><span class=n>ReplenishFood</span><span class=p>();</span>

            <span class=c1>// more code to feed the animal
</span><span class=c1></span>        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>interface</span> <span class=n>IFeederService</span>
    <span class=p>{</span>
        <span class=k>void</span> <span class=n>ReplenishFood</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>FeederService</span> <span class=p>:</span> <span class=n>IFeederService</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=k>void</span> <span class=n>ReplenishFood</span><span class=p>()</span>
        <span class=p>{</span>
            <span class=n>Feeder</span><span class=p>.</span><span class=n>ReplenishFood</span><span class=p>();</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>static</span> <span class=k>class</span> <span class=nc>Feeder</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=k>static</span> <span class=k>void</span> <span class=n>ReplenishFood</span><span class=p>()</span>
        <span class=p>{</span>
            <span class=c1>// fill up bowl
</span><span class=c1></span>        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong>总结</strong>：这个重构在很多时候和设计模式中的一些思想类似，使用中间的装饰接口来分解两个类之间的依赖，对类进行装饰，然后使它满足我们所需要的功能。</p><h2 id=13-提取方法对象>13. 提取方法对象</h2><hr><p><strong>概念</strong>：本文中的“提取方法对象”是指当你发现一个方法中存在过多的局部变量时，你可以通过使用“提取方法对象”重构来引入一些方法，每个方法完成任务的一个步骤，这样可以使得程序变得更具有可读性。</p><p><strong>正文</strong>：如下代码所示，Order 类中的Calculate方法要完成很多功能，在之前我们用“提取方法”来进行重构，现在我们采取“提取方法对象”来完成重构。</p><p>正如下代码所示，我们引入了OrderCalculator类，该类实现了所有的计算方法，Order类将自身传递给 OrderCalculator类并调用Calculate方法完成计算过程。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System.Collections.Generic</span><span class=p>;</span>
<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.ExtractMethodObject.Before</span>
<span class=p>{</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>OrderLineItem</span>
    <span class=p>{</span>        
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>Price</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=p>}</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Order</span>
    <span class=p>{</span>        
        <span class=k>private</span> <span class=n>IList</span><span class=p>&lt;</span><span class=n>OrderLineItem</span><span class=p>&gt;</span> <span class=n>OrderLineItems</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>        
        <span class=k>private</span> <span class=n>IList</span><span class=p>&lt;</span><span class=kt>decimal</span><span class=p>&gt;</span> <span class=n>Discounts</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>        
        <span class=k>private</span> <span class=kt>decimal</span> <span class=n>Tax</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>        
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>Calculate</span><span class=p>()</span>
        <span class=p>{</span>            
            <span class=kt>decimal</span> <span class=n>subTotal</span> <span class=p>=</span> <span class=m>0</span><span class=n>m</span><span class=p>;</span>            
            <span class=c1>// Total up line items
</span><span class=c1></span>            <span class=k>foreach</span> <span class=p>(</span><span class=n>OrderLineItem</span> <span class=n>lineItem</span> <span class=k>in</span> <span class=n>OrderLineItems</span><span class=p>)</span>
            <span class=p>{</span>
                <span class=n>subTotal</span> <span class=p>+=</span> <span class=n>lineItem</span><span class=p>.</span><span class=n>Price</span><span class=p>;</span>
            <span class=p>}</span>            
            <span class=c1>// Subtract Discounts
</span><span class=c1></span>            <span class=k>foreach</span> <span class=p>(</span><span class=kt>decimal</span> <span class=n>discount</span> <span class=k>in</span> <span class=n>Discounts</span><span class=p>)</span>
                <span class=n>subTotal</span> <span class=p>-=</span> <span class=n>discount</span><span class=p>;</span>            <span class=c1>// Calculate Tax
</span><span class=c1></span>            <span class=kt>decimal</span> <span class=n>tax</span> <span class=p>=</span> <span class=n>subTotal</span> <span class=p>*</span> <span class=n>Tax</span><span class=p>;</span>            <span class=c1>// Calculate GrandTotal
</span><span class=c1></span>            <span class=kt>decimal</span> <span class=n>grandTotal</span> <span class=p>=</span> <span class=n>subTotal</span> <span class=p>+</span> <span class=n>tax</span><span class=p>;</span>            <span class=k>return</span> <span class=n>grandTotal</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System.Collections.Generic</span><span class=p>;</span>
<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.ExtractMethodObject.After</span>
<span class=p>{</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>OrderLineItem</span>
    <span class=p>{</span>        
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>Price</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=p>}</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Order</span>
    <span class=p>{</span>        
        <span class=k>public</span> <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>OrderLineItem</span><span class=p>&gt;</span> <span class=n>OrderLineItems</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>        
        <span class=k>public</span> <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=kt>decimal</span><span class=p>&gt;</span> <span class=n>Discounts</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>        
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>Tax</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>        
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>Calculate</span><span class=p>()</span>
        <span class=p>{</span>            
            <span class=k>return</span> <span class=k>new</span> <span class=n>OrderCalculator</span><span class=p>(</span><span class=k>this</span><span class=p>).</span><span class=n>Calculate</span><span class=p>();</span>
        <span class=p>}</span>
    <span class=p>}</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>OrderCalculator</span>
    <span class=p>{</span>        
        <span class=k>private</span> <span class=kt>decimal</span> <span class=n>SubTotal</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>        
        <span class=k>private</span> <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>OrderLineItem</span><span class=p>&gt;</span> <span class=n>OrderLineItems</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>        
        <span class=k>private</span> <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=kt>decimal</span><span class=p>&gt;</span> <span class=n>Discounts</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>        
        <span class=k>private</span> <span class=kt>decimal</span> <span class=n>Tax</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>        
        <span class=k>public</span> <span class=n>OrderCalculator</span><span class=p>(</span><span class=n>Order</span> <span class=n>order</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>OrderLineItems</span> <span class=p>=</span> <span class=n>order</span><span class=p>.</span><span class=n>OrderLineItems</span><span class=p>;</span>
            <span class=n>Discounts</span> <span class=p>=</span> <span class=n>order</span><span class=p>.</span><span class=n>Discounts</span><span class=p>;</span>
            <span class=n>Tax</span> <span class=p>=</span> <span class=n>order</span><span class=p>.</span><span class=n>Tax</span><span class=p>;</span>
        <span class=p>}</span>        
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>Calculate</span><span class=p>()</span>
        <span class=p>{</span>
            <span class=n>CalculateSubTotal</span><span class=p>();</span>
            <span class=n>SubtractDiscounts</span><span class=p>();</span>
            <span class=n>CalculateTax</span><span class=p>();</span>            
            <span class=k>return</span> <span class=n>SubTotal</span><span class=p>;</span>
        <span class=p>}</span>        
        <span class=k>private</span> <span class=k>void</span> <span class=n>CalculateSubTotal</span><span class=p>()</span>
        <span class=p>{</span>            
            <span class=c1>// Total up line items
</span><span class=c1></span>            <span class=k>foreach</span> <span class=p>(</span><span class=n>OrderLineItem</span> <span class=n>lineItem</span> <span class=k>in</span> <span class=n>OrderLineItems</span><span class=p>)</span>
                <span class=n>SubTotal</span> <span class=p>+=</span> <span class=n>lineItem</span><span class=p>.</span><span class=n>Price</span><span class=p>;</span>
        <span class=p>}</span>        
        <span class=k>private</span> <span class=k>void</span> <span class=n>SubtractDiscounts</span><span class=p>()</span>
        <span class=p>{</span>            
            <span class=c1>// Subtract Discounts
</span><span class=c1></span>            <span class=k>foreach</span> <span class=p>(</span><span class=kt>decimal</span> <span class=n>discount</span> <span class=k>in</span> <span class=n>Discounts</span><span class=p>)</span>
                <span class=n>SubTotal</span> <span class=p>-=</span> <span class=n>discount</span><span class=p>;</span>
        <span class=p>}</span>        
        <span class=k>private</span> <span class=k>void</span> <span class=n>CalculateTax</span><span class=p>()</span>
        <span class=p>{</span>            
            <span class=c1>// Calculate Tax
</span><span class=c1></span>            <span class=n>SubTotal</span> <span class=p>+=</span> <span class=n>SubTotal</span> <span class=p>*</span> <span class=n>Tax</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong>总结</strong>：本文的重构方法在有的时候还是比较有用，但这样会造成字段的增加，同时也会带来一些维护的不便，它和“提取方法”最大的区别就是一个通过方法返回需要的数据，另一个则是通过字段来存储方法的结果值，所以在很大程度上我们都会选择“提取方法”。</p><h2 id=14-分离职责>14. 分离职责</h2><hr><p><strong>概念</strong>：本文中的“分离职责”是指当一个类有许多职责时，将部分职责分离到独立的类中，这样也符合面向对象的五大特征之一的单一职责原则，同时也可以使代码的结构更加清晰，维护性更高。</p><p><strong>正文</strong>：如下代码所示，Video类有两个职责，一个是处理video rental，另一个是计算每个客户的总租金。我们可以将这两个职责分离出来，因为计算每个客户的总租金可以在Customer计算，这也比较符合常理。</p><p>重构后的代码如下，这样Video 的职责就变得很清晰，同时也使代码维护性更好。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System.Collections.Generic</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Linq</span><span class=p>;</span>
<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.BreakResponsibilities.Before</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Video</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=k>void</span> <span class=n>PayFee</span><span class=p>(</span><span class=kt>decimal</span> <span class=n>fee</span><span class=p>)</span>
        <span class=p>{</span>
        <span class=p>}</span>

        <span class=k>public</span> <span class=k>void</span> <span class=n>RentVideo</span><span class=p>(</span><span class=n>Video</span> <span class=n>video</span><span class=p>,</span> <span class=n>Customer</span> <span class=n>customer</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>customer</span><span class=p>.</span><span class=n>Videos</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=n>video</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>CalculateBalance</span><span class=p>(</span><span class=n>Customer</span> <span class=n>customer</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>returncustomer</span><span class=p>.</span><span class=n>LateFees</span><span class=p>.</span><span class=n>Sum</span><span class=p>();</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>Customer</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=n>IList</span><span class=p>&lt;</span><span class=kt>decimal</span><span class=p>&gt;</span> <span class=n>LateFees</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
        <span class=k>public</span> <span class=n>IList</span><span class=p>&lt;</span><span class=n>Video</span><span class=p>&gt;</span> <span class=n>Videos</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System.Collections.Generic</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Linq</span><span class=p>;</span>
<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.BreakResponsibilities.After</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Video</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=k>void</span> <span class=n>RentVideo</span><span class=p>(</span><span class=n>Video</span> <span class=n>video</span><span class=p>,</span> <span class=n>Customer</span> <span class=n>customer</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>customer</span><span class=p>.</span><span class=n>Videos</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=n>video</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>Customer</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=n>IList</span><span class=p>&lt;</span><span class=kt>decimal</span><span class=p>&gt;</span> <span class=n>LateFees</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
        <span class=k>public</span> <span class=n>IList</span><span class=p>&lt;</span><span class=n>Video</span><span class=p>&gt;</span> <span class=n>Videos</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>

        <span class=k>public</span> <span class=k>void</span> <span class=n>PayFee</span><span class=p>(</span><span class=kt>decimal</span> <span class=n>fee</span><span class=p>)</span>
        <span class=p>{</span>
        <span class=p>}</span>

        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>CalculateBalance</span><span class=p>(</span><span class=n>Customer</span> <span class=n>customer</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=k>return</span> <span class=n>customer</span><span class=p>.</span><span class=n>LateFees</span><span class=p>.</span><span class=n>Sum</span><span class=p>();</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong>总结</strong>：这个重构经常会用到，它和之前的“移动方法”有几分相似之处，让方法放在合适的类中，并且简化类的职责，同时这也是面向对象五大原则之一和设计模式中的重要思想。</p><h2 id=15移除重复内容>15.移除重复内容</h2><hr><p><strong>概念</strong>：本文中的“移除重复内容”是指把一些很多地方都用到的逻辑提炼出来，然后提供给调用者统一调用。</p><p><strong>正文</strong>：如下代码所示，ArchiveRecord和CloseRecord都会用到Archived = true; 和DateArchived = DateTime.Now; 这两条语句，所以我们就可以对它进行重构。</p><p>重构后的代码如下所示，我们提炼了SwitchToArchived方法来封装公用的操作，然后给ArchiveRecord和CloseRecord统一调用。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System</span><span class=p>;</span>
<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.RemoveDuplication.Before</span>
<span class=p>{</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>MedicalRecord</span>
    <span class=p>{</span>        
        <span class=k>public</span> <span class=n>DateTime</span> <span class=n>DateArchived</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>        
        <span class=k>public</span> <span class=kt>bool</span> <span class=n>Archived</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>        
        <span class=k>public</span> <span class=k>void</span> <span class=n>ArchiveRecord</span><span class=p>()</span>
        <span class=p>{</span>
            <span class=n>Archived</span> <span class=p>=</span> <span class=k>true</span><span class=p>;</span>
            <span class=n>DateArchived</span> <span class=p>=</span> <span class=n>DateTime</span><span class=p>.</span><span class=n>Now</span><span class=p>;</span>
        <span class=p>}</span>        
        <span class=k>public</span> <span class=k>void</span> <span class=n>CloseRecord</span><span class=p>()</span>
        <span class=p>{</span>
            <span class=n>Archived</span> <span class=p>=</span> <span class=k>true</span><span class=p>;</span>
            <span class=n>DateArchived</span> <span class=p>=</span> <span class=n>DateTime</span><span class=p>.</span><span class=n>Now</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=n>sing</span> <span class=n>System</span><span class=p>;</span>
<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.RemoveDuplication.After</span>
<span class=p>{</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>MedicalRecord</span>
    <span class=p>{</span>        
        <span class=k>public</span> <span class=n>DateTime</span> <span class=n>DateArchived</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>        
        <span class=k>public</span> <span class=kt>bool</span> <span class=n>Archived</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>        
        <span class=k>public</span> <span class=k>void</span> <span class=n>ArchiveRecord</span><span class=p>()</span>
        <span class=p>{</span>
            <span class=n>SwitchToArchived</span><span class=p>();</span>
        <span class=p>}</span>        
        <span class=k>public</span> <span class=k>void</span> <span class=n>CloseRecord</span><span class=p>()</span>
        <span class=p>{</span>
            <span class=n>SwitchToArchived</span><span class=p>();</span>
        <span class=p>}</span>        
        <span class=k>private</span> <span class=k>void</span> <span class=n>SwitchToArchived</span><span class=p>()</span>
        <span class=p>{</span>
            <span class=n>Archived</span> <span class=p>=</span> <span class=k>true</span><span class=p>;</span>
            <span class=n>DateArchived</span> <span class=p>=</span> <span class=n>DateTime</span><span class=p>.</span><span class=n>Now</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong>总结</strong>：这个重构很简单，绝大多数程序员都会使用这种重构方法，但有时由于习惯、时间、赶进度等原因而忽略它，所以会使得整个系统杂乱无章，到处都是Ctrl+C和Ctrl+V的痕迹。</p><h2 id=16-封装条件>16. 封装条件</h2><hr><p><strong>概念</strong>：本文中的“封装条件”是指条件关系比较复杂时，代码的可读性会比较差，所以这时我们应当根据条件表达式是否需要参数将条件表达式提取成可读性更好的属性或者方法，如果条件表达式不需要参数则可以提取成属性，如果条件表达式需要参数则可以提取成方法。</p><p><strong>正文</strong>：如下代码所示，PerformCoolFunction里面的if条件判断比较复杂，看起来有点杂乱，所以就把它提出来。</p><p>如下代码所示，我们把条件表达式封装成HasExtraFunctions属性，这样先前的条件判断就成了if (HasExtraFunctions) ，所以这样就在很大程度上提高了可读性。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System</span><span class=p>;</span>
<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.EncapsulateConditional.Before</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>RemoteControl</span>
    <span class=p>{</span>
        <span class=k>private</span> <span class=kt>string</span><span class=p>[]</span> <span class=n>Functions</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
        <span class=k>private</span> <span class=kt>string</span> <span class=n>Name</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
        <span class=k>private</span> <span class=kt>int</span> <span class=n>CreatedYear</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
        <span class=k>public</span> <span class=kt>string</span> <span class=n>PerformCoolFunction</span><span class=p>(</span><span class=kt>string</span> <span class=n>buttonPressed</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=c1>// Determine if we are controlling some extra function
</span><span class=c1></span>            <span class=c1>// that requires special conditions
</span><span class=c1></span>            <span class=k>if</span> <span class=p>(</span><span class=n>Functions</span><span class=p>.</span><span class=n>Length</span> <span class=p>&gt;</span> <span class=m>1</span> <span class=p>&amp;&amp;</span> <span class=n>Name</span> <span class=p>==</span> <span class=s>&#34;RCA&#34;</span> <span class=p>&amp;&amp;</span> <span class=n>CreatedYear</span> <span class=p>&gt;</span> <span class=n>DateTime</span><span class=p>.</span><span class=n>Now</span><span class=p>.</span><span class=n>Year</span> <span class=p>-</span> <span class=m>2</span><span class=p>)</span>
                <span class=k>return</span> <span class=s>&#34;doSomething&#34;</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System</span><span class=p>;</span>
<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.EncapsulateConditional.After</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>RemoteControl</span>
    <span class=p>{</span>
        <span class=k>private</span> <span class=kt>string</span><span class=p>[]</span> <span class=n>Functions</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
        <span class=k>private</span> <span class=kt>string</span> <span class=n>Name</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
        <span class=k>private</span> <span class=kt>int</span> <span class=n>CreatedYear</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
        <span class=k>private</span> <span class=kt>bool</span> <span class=n>HasExtraFunctions</span>
        <span class=p>{</span>
            <span class=k>get</span> <span class=p>{</span> <span class=k>return</span> <span class=n>Functions</span><span class=p>.</span><span class=n>Length</span> <span class=p>&gt;</span> <span class=m>1</span> <span class=p>&amp;&amp;</span> <span class=n>Name</span> <span class=p>==</span> <span class=s>&#34;RCA&#34;</span> <span class=p>&amp;&amp;</span> <span class=n>CreatedYear</span> <span class=p>&gt;</span> <span class=n>DateTime</span><span class=p>.</span><span class=n>Now</span><span class=p>.</span><span class=n>Year</span> <span class=p>-</span> <span class=m>2</span><span class=p>;</span> <span class=p>}</span>
        <span class=p>}</span>
        <span class=k>public</span> <span class=kt>string</span> <span class=n>PerformCoolFunction</span><span class=p>(</span><span class=kt>string</span> <span class=n>buttonPressed</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=c1>// Determine if we are controlling some extra function
</span><span class=c1></span>            <span class=c1>// that requires special conditions
</span><span class=c1></span>            <span class=k>if</span> <span class=p>(</span><span class=n>HasExtraFunctions</span><span class=p>)</span>
                <span class=k>return</span> <span class=s>&#34;doSomething&#34;</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong>总结</strong>：这个重构在很大程度上能改善代码的可读性，尤其是在一个逻辑很复杂的应用中，把这些条件判断封装成一个有意义的名字，这样很复杂的逻辑也会立刻变得简单起来。</p><h2 id=17-提取父类>17. 提取父类</h2><hr><p><strong>正文</strong>：Dog 类中的EatFood和Groom有可能被其他类用到，因为他们都是动物的一些公有性质，所以这个时候我们就会考虑对它进行提炼。</p><p>代码如下所示，提取了Animal 方法来封装公用的EatFood和Groom类，从而使其他继承了Animal 类的子类都可以使用这两个方法了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.ExtractSuperclass.Before</span>
<span class=p>{</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Dog</span>    
    <span class=p>{</span>        
        <span class=k>public</span> <span class=k>void</span> <span class=n>EatFood</span><span class=p>()</span>        
        <span class=p>{</span>            
            <span class=c1>// eat some food        
</span><span class=c1></span>        <span class=p>}</span>
        
        <span class=k>public</span> <span class=k>void</span> <span class=n>Groom</span><span class=p>()</span> 
        <span class=p>{</span> 
        <span class=c1>// perform grooming 
</span><span class=c1></span>        <span class=p>}</span> 
    <span class=p>}</span> 
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.ExtractSuperclass.After</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Animal</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=k>void</span> <span class=n>EatFood</span><span class=p>()</span>
        <span class=p>{</span>
            <span class=c1>// eat some food
</span><span class=c1></span>        <span class=p>}</span>
        <span class=k>public</span> <span class=k>void</span> <span class=n>Groom</span><span class=p>()</span>
        <span class=p>{</span>
            <span class=c1>// perform grooming
</span><span class=c1></span>        <span class=p>}</span>
    <span class=p>}</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Dog</span> <span class=p>:</span> <span class=n>Animal</span>
    <span class=p>{</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong>总结</strong>：这个重构是典型的继承用法，很多程序员都会选择这样做，但是要注意正确的使用，不要造成过度使用了继承，如果过度使用了，请考虑用接口、组合和聚合来实现。</p><h2 id=18使用条件判断代替异常>18.使用条件判断代替异常</h2><hr><p><strong>概念</strong>：本文中的“使用条件判断代替异常”是指把没有必要使用异常做判断的条件尽量改为条件判断。</p><p><strong>正文</strong>：如下代码所示，在日常的编码中我们经常需要用到异常来控制程序流，Start方法里面用try  catch 做条件判断，我们知道这里没有必要使用这种方式，因为你不需要做类型不可控的类型转换，也不需要处理异常行为，所以我们应该对它进行重构。</p><p>重构后的代码如下所示，try   catch做条件判断的语句改成了if   return的方式，这样在很多程度上统一了代码的书写，同时也提高了性能。</p><p>}</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.ReplaceException.Before</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Microwave</span>
    <span class=p>{</span>
        <span class=k>private</span> <span class=n>IMicrowaveMotor</span> <span class=n>Motor</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>

        <span class=k>public</span> <span class=kt>bool</span> <span class=n>Start</span><span class=p>(</span><span class=kt>object</span> <span class=n>food</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=kt>bool</span> <span class=n>foodCooked</span> <span class=p>=</span> <span class=k>false</span><span class=p>;</span>
            <span class=k>try</span>
            <span class=p>{</span>
                <span class=n>Motor</span><span class=p>.</span><span class=n>Cook</span><span class=p>(</span><span class=n>food</span><span class=p>);</span>
                <span class=n>foodCooked</span> <span class=p>=</span> <span class=k>true</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=k>catch</span> <span class=p>(</span><span class=n>InUseException</span><span class=p>)</span>
            <span class=p>{</span>
                <span class=n>foodcooked</span> <span class=p>=</span> <span class=k>false</span><span class=p>;</span>
            <span class=p>}</span>

            <span class=k>return</span> <span class=n>foodCooked</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.ReplaceException.After</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Microwave</span>
    <span class=p>{</span>
        <span class=k>private</span> <span class=n>IMicrowaveMotor</span> <span class=n>Motor</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>

        <span class=k>public</span> <span class=kt>bool</span> <span class=n>Start</span><span class=p>(</span><span class=kt>object</span> <span class=n>food</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>Motor</span><span class=p>.</span><span class=n>IsInUse</span><span class=p>)</span>
                <span class=k>return</span> <span class=k>false</span><span class=p>;</span>

            <span class=n>Motor</span><span class=p>.</span><span class=n>Cook</span><span class=p>(</span><span class=n>food</span><span class=p>);</span>

            <span class=k>return</span> <span class=k>true</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong>总结</strong>： 这个重构在项目代码中也经常用到，因为对于一部分程序员，是很难把握什么时候用try   catch ，什么地方该用try   catch。记得之前大家还专门讨论过这些，比如如何用好以及在大中型项目中应该把它放在哪一个组件中等。</p><h2 id=19提取工厂类>19.提取工厂类</h2><hr><p><strong>概念</strong>：本文中的“提取工厂类”是指如果要创建的对象很多，则代码会变的很复杂。一种很好的方法就是提取工厂类。</p><p><strong>正文</strong>：一般来说我们需要在代码中设置一些对象，以便获得它们的状态，从而使用对象，所谓的设置通常来说就是创建对象的实例并调用对象的方法。有时如果要创建的对象很多，则代码会变的很复杂。这便是工厂模式发挥作用的情形。工厂模式的复杂应用是使用抽象工厂创建对象集，但我们在这里只是使用基本的工厂类创建对象的一个简单应用。</p><p>如下代码所示，New方法包含创建类的整个逻辑，如果现在要创建的类比较多而且逻辑比较复杂的话（如根据不同条件创建对象，什么时候创建对象），我们的New方法逻辑会变得很大，同时代码也变得很难维护。所以我们就会采用提取工厂类的方式进行提炼。</p><p>那么重构后的代码如下，New方法变得很简单了，指需要调用实现接IPoliceCarFactory 接口的PoliceCarFactory 类就可以返回对象，这样就隔开了创建对象的逻辑，如果需求现在变为根据不同的条件创建不同的对象，什么时候创建对象等都变成了比较简单的事情，在后期可以把对象都配置在XML里面，使用反射的方式实现IOC注入创建。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.ExtractServiceClass.Before</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>PoliceCarController</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=n>PoliceCar</span> <span class=n>New</span><span class=p>(</span><span class=kt>int</span> <span class=n>mileage</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>serviceRequired</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>PoliceCar</span> <span class=n>policeCar</span> <span class=p>=</span> <span class=k>new</span> <span class=n>PoliceCar</span><span class=p>();</span>
            <span class=n>policeCar</span><span class=p>.</span><span class=n>ServiceRequired</span> <span class=p>=</span> <span class=n>serviceRequired</span><span class=p>;</span>
            <span class=n>policeCar</span><span class=p>.</span><span class=n>Mileage</span> <span class=p>=</span> <span class=n>mileage</span><span class=p>;</span>

            <span class=k>return</span> <span class=n>policeCar</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.ExtractServiceClass.After</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>interface</span> <span class=n>IPoliceCarFactory</span>
    <span class=p>{</span>
        <span class=n>PoliceCar</span> <span class=n>Create</span><span class=p>(</span><span class=kt>int</span> <span class=n>mileage</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>serviceRequired</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>PoliceCarFactory</span> <span class=p>:</span> <span class=n>IPoliceCarFactory</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=n>PoliceCar</span> <span class=n>Create</span><span class=p>(</span><span class=kt>int</span> <span class=n>mileage</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>serviceRequired</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>PoliceCar</span> <span class=n>policeCar</span> <span class=p>=</span> <span class=k>new</span> <span class=n>PoliceCar</span><span class=p>();</span>
            <span class=n>policeCar</span><span class=p>.</span><span class=n>ReadForService</span> <span class=p>=</span> <span class=n>serviceRequired</span><span class=p>;</span>
            <span class=n>policeCar</span><span class=p>.</span><span class=n>Mileage</span> <span class=p>=</span> <span class=n>mileage</span><span class=p>;</span>
            <span class=k>return</span> <span class=n>policeCar</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>PoliceCarController</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=n>IPoliceCarFactory</span> <span class=n>PoliceCarFactory</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>

        <span class=k>public</span> <span class=n>PoliceCarController</span><span class=p>(</span><span class=n>IPoliceCarFactory</span> <span class=n>policeCarFactory</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>PoliceCarFactory</span> <span class=p>=</span> <span class=n>policeCarFactory</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=k>public</span> <span class=n>PoliceCar</span> <span class=n>New</span><span class=p>(</span><span class=kt>int</span> <span class=n>mileage</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>serviceRequired</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=k>return</span> <span class=n>PoliceCarFactory</span><span class=p>.</span><span class=n>Create</span><span class=p>(</span><span class=n>mileage</span><span class=p>,</span> <span class=n>serviceRequired</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong>总结</strong>：这个重构经常会在项目中使用，如果要创建的对象是一个，你可以采用简单工厂，但是这种方式还是会存在很多依赖，维护起来也比较不方便。所以推荐使用工厂方法模式，把实例化延迟到子类。如果你要创建一系列的对象，那么就推荐你使用抽象工厂模式，但是要注意不要过度设计，只要能满足不断变化的需求和给以后的维护和重构带来方便即可。</p><h2 id=20提取子类>20.提取子类</h2><hr><p><strong>概念</strong>：本文中的”提取子类”是指把基类中的一些不是所有子类都需要访问的方法调整到子类中。</p><p><strong>正文</strong>：当你的基类中存在一些方法不是所有的子类都需要访问，你想将它们调整到子类中时，这个重构会变得很有用了。如下代码所示，我们需要一个 Registration类用来处理学生选课的信息。但是当Registration类开始工作后，我们意识到我们会在两种不同的上下文中使用 Registration类，NonRegistrationAction和Notes只有在我们处理未注册情况下才用到。</p><p>所以我们将NonRegistration和Notes提到单独的NonRegistration类中。</p><p>重构后的代码如下所示，这样也满足面向对象五大原则之一的单一职责。同时也让类的结构变得更加清晰，增强了可维护性。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System</span><span class=p>;</span>
<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.ExtractSubclass.Before</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Registration</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=n>NonRegistrationAction</span> <span class=n>Action</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>RegistrationTotal</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
        <span class=k>public</span> <span class=kt>string</span> <span class=n>Notes</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
        <span class=k>public</span> <span class=kt>string</span> <span class=n>Description</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
        <span class=k>public</span> <span class=n>DateTime</span> <span class=n>RegistrationDate</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System</span><span class=p>;</span>
<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.ExtractSubclass.After</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Registration</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>RegistrationTotal</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
        <span class=k>public</span> <span class=kt>string</span> <span class=n>Description</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
        <span class=k>public</span> <span class=n>DateTime</span> <span class=n>RegistrationDate</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>NonRegistration</span> <span class=p>:</span> <span class=n>Registration</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=n>NonRegistrationAction</span> <span class=n>Action</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
        <span class=k>public</span> <span class=kt>string</span> <span class=n>Notes</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong>总结</strong>：这个重构方法经常用来规范类的职责，和之前的一些重构方法也有些类似。</p><h2 id=21合并继承>21.合并继承</h2><hr><p><strong>概念</strong>：本文中的”合并继承”是指如果子类的属性和方法也适合于基类，那么就可以移除子类，从而减少依赖关系。</p><p><strong>正文</strong>：上一篇我们讲到“提取子类”重构是指当基类中的一个责任不被所有的子类所需要时，将这些责任提取到合适的子类中。而我们今天所要讲的的“合并继承”重构一般用在当我们觉得不需要子类的时候。</p><p>如下代码所示，StudentWebSite子类除了有一个属性用来说明网站是否是活动的外没有别的责任，在这种情形下我们意识到IsActive属性可以应用到所有的网站，所以我们可以将IsActive属性上移到基类中，并去掉StudentWebSite类。</p><p>重构后的代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System.Collections.Generic</span><span class=p>;</span>
<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.CollapseHierarchy.Before</span>
<span class=p>{</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Website</span>
    <span class=p>{</span>        
        <span class=k>public</span> <span class=kt>string</span> <span class=n>Title</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>        
        <span class=k>public</span> <span class=kt>string</span> <span class=n>Description</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>        
        <span class=k>public</span> <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>Webpage</span><span class=p>&gt;</span> <span class=n>Pages</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=p>}</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>StudentWebsite</span> <span class=p>:</span> <span class=n>Website</span>
    <span class=p>{</span>        
        <span class=k>public</span> <span class=kt>bool</span> <span class=n>IsActive</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System.Collections.Generic</span><span class=p>;</span>
<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.CollapseHierarchy.After</span>
<span class=p>{</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Website</span>
    <span class=p>{</span>        
        <span class=k>public</span> <span class=kt>string</span> <span class=n>Title</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>        
        <span class=k>public</span> <span class=kt>string</span> <span class=n>Description</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>        
        <span class=k>public</span> <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>Webpage</span><span class=p>&gt;</span> <span class=n>Pages</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>        
        <span class=k>public</span> <span class=kt>bool</span> <span class=n>IsActive</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong>总结</strong>： 这篇和上篇其实最主要论述了子类和父类的继承关系以及如何判断什么时候需要使用继承，一般我们都能处理好这些关系，所以相对比较简单。</p><h2 id=22分解方法>22.分解方法</h2><hr><p><strong>概念</strong>：本文中的”分解方法”是指把我们所做的这个功能不停的分解方法，直到将一个大方法分解为名字有意义且可读性更好的若干个小方法。</p><p><strong>正文</strong>：如下代码所示，因为现实中AcceptPayment方法不会做这么多的事情。，所以我们通过几次分解将 AcceptPayment拆分成若干个名字有意义且可读性更好的小方法。</p><p>重构后的代码如下，我们把AcceptPayment的内部逻辑拆分成了CalculateSubtotal、SubtractDiscounts、AddTax、SubtractFromCustomerBalance四个功能明确且可读性更好的小方法。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System.Collections.Generic</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Linq</span><span class=p>;</span>
<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.BreakMethod.Before</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>CashRegister</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=n>CashRegister</span><span class=p>()</span>
        <span class=p>{</span>
            <span class=n>Tax</span> <span class=p>=</span> <span class=m>0.06</span><span class=n>m</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=k>private</span> <span class=kt>decimal</span> <span class=n>Tax</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>

        <span class=k>public</span> <span class=k>void</span> <span class=n>AcceptPayment</span><span class=p>(</span><span class=n>Customer</span> <span class=n>customer</span><span class=p>,</span> <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>Product</span><span class=p>&gt;</span> <span class=n>products</span><span class=p>,</span> <span class=kt>decimal</span> <span class=n>payment</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=kt>decimal</span> <span class=n>subTotal</span> <span class=p>=</span> <span class=m>0</span><span class=n>m</span><span class=p>;</span>
            <span class=k>foreach</span> <span class=p>(</span><span class=n>Product</span> <span class=n>product</span> <span class=k>in</span> <span class=n>products</span><span class=p>)</span>
            <span class=p>{</span>
                <span class=n>subTotal</span> <span class=p>+=</span> <span class=n>product</span><span class=p>.</span><span class=n>Price</span><span class=p>;</span>
            <span class=p>}</span>

            <span class=k>foreach</span> <span class=p>(</span><span class=n>Product</span> <span class=n>product</span> <span class=k>in</span> <span class=n>products</span><span class=p>)</span>
            <span class=p>{</span>
                <span class=n>subTotal</span> <span class=p>-=</span> <span class=n>product</span><span class=p>.</span><span class=n>AvailableDiscounts</span><span class=p>;</span>
            <span class=p>}</span>

            <span class=kt>decimal</span> <span class=n>grandTotal</span> <span class=p>=</span> <span class=n>subTotal</span> <span class=p>*</span> <span class=n>Tax</span><span class=p>;</span>

            <span class=n>customer</span><span class=p>.</span><span class=n>DeductFromAccountBalance</span><span class=p>(</span><span class=n>grandTotal</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>Customer</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=k>void</span> <span class=n>DeductFromAccountBalance</span><span class=p>(</span><span class=kt>decimal</span> <span class=n>amount</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=c1>// deduct from balance
</span><span class=c1></span>        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>Product</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>Price</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>AvailableDiscounts</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System.Collections.Generic</span><span class=p>;</span>
<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.BreakMethod.After</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>CashRegister</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=n>CashRegister</span><span class=p>()</span>
        <span class=p>{</span>
            <span class=n>Tax</span> <span class=p>=</span> <span class=m>0.06</span><span class=n>m</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=k>private</span> <span class=kt>decimal</span> <span class=n>Tax</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
        <span class=k>private</span> <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>Product</span><span class=p>&gt;</span> <span class=n>Products</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>

        <span class=k>public</span> <span class=k>void</span> <span class=n>AcceptPayment</span><span class=p>(</span><span class=n>Customer</span> <span class=n>customer</span><span class=p>,</span> <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>Product</span><span class=p>&gt;</span> <span class=n>products</span><span class=p>,</span> <span class=kt>decimal</span> <span class=n>payment</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=kt>decimal</span> <span class=n>subTotal</span> <span class=p>=</span> <span class=n>CalculateSubtotal</span><span class=p>();</span>

            <span class=n>subTotal</span> <span class=p>=</span> <span class=n>SubtractDiscounts</span><span class=p>(</span><span class=n>subTotal</span><span class=p>);</span>

            <span class=kt>decimal</span> <span class=n>grandTotal</span> <span class=p>=</span> <span class=n>AddTax</span><span class=p>(</span><span class=n>subTotal</span><span class=p>);</span>

            <span class=n>SubtractFromCustomerBalance</span><span class=p>(</span><span class=n>customer</span><span class=p>,</span> <span class=n>grandTotal</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=k>private</span> <span class=k>void</span> <span class=n>SubtractFromCustomerBalance</span><span class=p>(</span><span class=n>Customer</span> <span class=n>customer</span><span class=p>,</span> <span class=kt>decimal</span> <span class=n>grandTotal</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>customer</span><span class=p>.</span><span class=n>DeductFromAccountBalance</span><span class=p>(</span><span class=n>grandTotal</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=k>private</span> <span class=kt>decimal</span> <span class=n>AddTax</span><span class=p>(</span><span class=kt>decimal</span> <span class=n>subTotal</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=k>return</span> <span class=n>subTotal</span> <span class=p>*</span> <span class=n>Tax</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=k>private</span> <span class=kt>decimal</span> <span class=n>SubtractDiscounts</span><span class=p>(</span><span class=kt>decimal</span> <span class=n>subTotal</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=k>foreach</span> <span class=p>(</span><span class=n>Product</span> <span class=n>product</span> <span class=k>in</span> <span class=n>Products</span><span class=p>)</span>
            <span class=p>{</span>
                <span class=n>subTotal</span> <span class=p>-=</span> <span class=n>product</span><span class=p>.</span><span class=n>AvailableDiscounts</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=k>return</span> <span class=n>subTotal</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=k>private</span> <span class=kt>decimal</span> <span class=n>CalculateSubtotal</span><span class=p>()</span>
        <span class=p>{</span>
            <span class=kt>decimal</span> <span class=n>subTotal</span> <span class=p>=</span> <span class=m>0</span><span class=n>m</span><span class=p>;</span>
            <span class=k>foreach</span> <span class=p>(</span><span class=n>Product</span> <span class=n>product</span> <span class=k>in</span> <span class=n>Products</span><span class=p>)</span>
            <span class=p>{</span>
                <span class=n>subTotal</span> <span class=p>+=</span> <span class=n>product</span><span class=p>.</span><span class=n>Price</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=k>return</span> <span class=n>subTotal</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>Customer</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=k>void</span> <span class=n>DeductFromAccountBalance</span><span class=p>(</span><span class=kt>decimal</span> <span class=n>amount</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=c1>// deduct from balance
</span><span class=c1></span>        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>Product</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>Price</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>AvailableDiscounts</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong>总结</strong>：其实这个重构和我们前面讲的“提取方法”和“提取方法对象”如出一辙，尤其是“提取方法”，所以大家只要知道用这种思想重构就行。</p><h2 id=23引入参数对象>23.引入参数对象</h2><hr><p><strong>概念</strong>：本文中的“引入参数对象”是指当一个方法的参数过多或者过为复杂时，可以考虑把这些参数封装成一个单独的类。</p><p><strong>正文</strong>：如果一个方法所需要的参数大于5个，理解该方法的签名就变得比较困难，因为这样感觉参数很长、样式不好并且没有分类，所以我们有必要把参数进行封装。</p><p>通常这种情形下创建一个用户传递参数的类是很有帮助的，这会使得代码更容易明白也更灵活，因为当你需要增加参数时，只需要给参数类添加一个属性即可。请注意只有当你发现方法的参数比较多时才应该应用该重构，如果方法的参数比较少，就没有必要应用此重构，因为该重构会增加系统中类的数量，同时也会加大维护负担。所以要看参数情况而定。<br>重构后的代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.ParameterObject.Before</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Registration</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=k>void</span> <span class=n>Create</span><span class=p>(</span><span class=kt>decimal</span> <span class=n>amount</span><span class=p>,</span> <span class=n>Student</span> <span class=n>student</span><span class=p>,</span> <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>Course</span><span class=p>&gt;</span> <span class=n>courses</span><span class=p>,</span> <span class=kt>decimal</span> <span class=n>credits</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=c1>// do work
</span><span class=c1></span>        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System.Collections.Generic</span><span class=p>;</span>
<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.ParameterObject.After</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>RegistrationContext</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>Amount</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
        <span class=k>public</span> <span class=n>Student</span> <span class=n>Student</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
        <span class=k>public</span> <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>Course</span><span class=p>&gt;</span> <span class=n>Courses</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>Credits</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>Registration</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=k>void</span> <span class=n>Create</span><span class=p>(</span><span class=n>RegistrationContext</span> <span class=n>registrationContext</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=c1>// do work
</span><span class=c1></span>        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong>总结</strong>：这种重构很重要，尤其是当一个方法的参数比较多的时候，不管是大中型项目还是小型项目，都会遇到这种场景，所以建议大家多使用这个重构。这种封装的思想在SOA 里面也经常运用到，封装输入Message，封装输出Message，消息来和消息去以及消息间的交互就构成了整个应用体系。</p><h2 id=24分解复杂判断>24.分解复杂判断</h2><hr><p><strong>概念</strong>：本文中的”分解复杂判断”是指把原来复杂的条件判断等语句用尽快返回等方式简化代码。</p><p><strong>正文</strong>：简单的来说，当你的代码中有很深的嵌套条件时，花括号就会在代码中形成一个长长的箭头。我们经常在不同的代码中看到这种情况，并且这种情况也会扰乱代码的可读性。</p><p>如下代码所示，HasAccess方法里面包含一些嵌套条件，如果再加一些条件或者增加复杂度，那么代码就很可能出现几个问题：1，可读性差。 2，很容易出现异常。 3，性能较差。</p><p>那么重构上面的代码也很简单，如果有可能的话，尽量将条件从方法中移除，我们让代码在做处理任务之前先检查条件，如果条件不满足就尽快返回，不继续执行。下面是重构后的代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Collections.Generic</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Linq</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Text</span><span class=p>;</span>

<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.ArrowheadAntipattern.Before</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Security</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=n>ISecurityChecker</span> <span class=n>SecurityChecker</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>

        <span class=k>public</span> <span class=n>Security</span><span class=p>(</span><span class=n>ISecurityChecker</span> <span class=n>securityChecker</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>SecurityChecker</span> <span class=p>=</span> <span class=n>securityChecker</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=k>public</span> <span class=kt>bool</span> <span class=n>HasAccess</span><span class=p>(</span><span class=n>User</span> <span class=n>user</span><span class=p>,</span> <span class=n>Permission</span> <span class=n>permission</span><span class=p>,</span> <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>Permission</span><span class=p>&gt;</span> <span class=n>exemptions</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=kt>bool</span> <span class=n>hasPermission</span> <span class=p>=</span> <span class=k>false</span><span class=p>;</span>

            <span class=k>if</span> <span class=p>(</span><span class=n>user</span> <span class=p>!=</span> <span class=k>null</span><span class=p>)</span>
            <span class=p>{</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>permission</span> <span class=p>!=</span> <span class=k>null</span><span class=p>)</span>
                <span class=p>{</span>
                    <span class=k>if</span> <span class=p>(</span><span class=n>exemptions</span><span class=p>.</span><span class=n>Count</span><span class=p>()</span> <span class=p>==</span> <span class=m>0</span><span class=p>)</span>
                    <span class=p>{</span>
                        <span class=k>if</span> <span class=p>(</span><span class=n>SecurityChecker</span><span class=p>.</span><span class=n>CheckPermission</span><span class=p>(</span><span class=n>user</span><span class=p>,</span> <span class=n>permission</span><span class=p>)</span> <span class=p>||</span> <span class=n>exemptions</span><span class=p>.</span><span class=n>Contains</span><span class=p>(</span><span class=n>permission</span><span class=p>))</span>
                        <span class=p>{</span>
                            <span class=n>hasPermission</span> <span class=p>=</span> <span class=k>true</span><span class=p>;</span>
                        <span class=p>}</span>
                    <span class=p>}</span>
                <span class=p>}</span>
            <span class=p>}</span>

            <span class=k>return</span> <span class=n>hasPermission</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System.Collections.Generic</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Linq</span><span class=p>;</span>

<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.ArrowheadAntipattern.After</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Security</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=n>ISecurityChecker</span> <span class=n>SecurityChecker</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>

        <span class=k>public</span> <span class=n>Security</span><span class=p>(</span><span class=n>ISecurityChecker</span> <span class=n>securityChecker</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>SecurityChecker</span> <span class=p>=</span> <span class=n>securityChecker</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=k>public</span> <span class=kt>bool</span> <span class=n>HasAccess</span><span class=p>(</span><span class=n>User</span> <span class=n>user</span><span class=p>,</span> <span class=n>Permission</span> <span class=n>permission</span><span class=p>,</span> <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>Permission</span><span class=p>&gt;</span> <span class=n>exemptions</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>user</span> <span class=p>==</span> <span class=k>null</span> <span class=p>||</span> <span class=n>permission</span> <span class=p>==</span> <span class=k>null</span><span class=p>)</span>
                <span class=k>return</span> <span class=k>false</span><span class=p>;</span>

            <span class=k>if</span> <span class=p>(</span><span class=n>exemptions</span><span class=p>.</span><span class=n>Contains</span><span class=p>(</span><span class=n>permission</span><span class=p>))</span>
                <span class=k>return</span> <span class=k>true</span><span class=p>;</span>

            <span class=k>return</span> <span class=n>SecurityChecker</span><span class=p>.</span><span class=n>CheckPermission</span><span class=p>(</span><span class=n>user</span><span class=p>,</span> <span class=n>permission</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong>总结</strong>：这个重构很重要，它和后面讲的”尽快返回“有些类似，我们在做复杂的处理过程时，要经常考虑这个重构，用好了它，会对我们的帮助很大。</p><h2 id=25引入契约式设计>25.引入契约式设计</h2><hr><p><strong>概念</strong>：本文中的”引入契约式设计”是指我们应该对应该对输入和输出进行验证，以确保系统不会出现我们所想象不到的异常和得不到我们想要的结果。</p><p><strong>正文</strong>：契约式设计规定方法应该对输入和输出进行验证，这样你便可以保证你得到的数据是可以工作的，一切都是按预期进行的，如果不是按预期进行，异常或是错误就应该被返回，下面我们举的例子中，我们方法中的参数可能会值为null的情况，在这种情况下由于我们没有验证，NullReferenceException异常会报出。另外在方法的结尾处我们也没有保证会返回一个正确的decimal值给调用方法的对象。</p><p>对上面的代码重构是很简单的，首先我们处理不会有一个null值的customer对象，检查我们最少会有一个product对象。在返回订单总和 之前先确保我们会返回一个有意义的值。如果上面说的检查有任何一个失败，我们就抛出对应的异常，并在异常里说明错误的详细信息，而不是直接抛出 NullReferenceException。</p><p>上面的代码中添加了额外的代码来进行验证，虽然看起来代码复杂度增加了，但我认为这是非常值得做的，因为当NullReferenceException发生时去追查异常的详细信息真是很令人讨厌的事情。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System</span><span class=p>;</span><span class=k>using</span> <span class=nn>System.Collections.Generic</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Linq</span><span class=p>;</span><span class=k>using</span> <span class=nn>System.Text</span><span class=p>;</span>
<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.Day25_DesignByContract</span>
<span class=p>{</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>CashRegister</span>
    <span class=p>{</span>        
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>TotalOrder</span><span class=p>(</span><span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>Product</span><span class=p>&gt;</span> <span class=n>products</span><span class=p>,</span> <span class=n>Customer</span> <span class=n>customer</span><span class=p>)</span>
        <span class=p>{</span>            
            <span class=kt>decimal</span> <span class=n>orderTotal</span> <span class=p>=</span> <span class=n>products</span><span class=p>.</span><span class=n>Sum</span><span class=p>(</span><span class=n>product</span> <span class=p>=&gt;</span> <span class=n>product</span><span class=p>.</span><span class=n>Price</span><span class=p>);</span>
            <span class=n>customer</span><span class=p>.</span><span class=n>Balance</span> <span class=p>+=</span> <span class=n>orderTotal</span><span class=p>;</span>            
            <span class=k>return</span> <span class=n>orderTotal</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Collections.Generic</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Linq</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Text</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>Microsoft.Contracts</span><span class=p>;</span>
<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.DesignByContract.After</span>
<span class=p>{</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>CashRegister</span>
    <span class=p>{</span>        
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>TotalOrder</span><span class=p>(</span><span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>Product</span><span class=p>&gt;</span> <span class=n>products</span><span class=p>,</span> <span class=n>Customer</span> <span class=n>customer</span><span class=p>)</span>
        <span class=p>{</span>            
            <span class=k>if</span> <span class=p>(</span><span class=n>customer</span> <span class=p>==</span> <span class=k>null</span><span class=p>)</span>                
                <span class=k>throw</span> <span class=k>new</span> <span class=n>ArgumentNullException</span><span class=p>(</span><span class=s>&#34;customer&#34;</span><span class=p>,</span> <span class=s>&#34;Customer cannot be null&#34;</span><span class=p>);</span>            
            <span class=k>if</span> <span class=p>(</span><span class=n>products</span><span class=p>.</span><span class=n>Count</span><span class=p>()</span> <span class=p>==</span> <span class=m>0</span><span class=p>)</span>                
                <span class=k>throw</span> <span class=k>new</span> <span class=n>ArgumentException</span><span class=p>(</span><span class=s>&#34;Must have at least one product to total&#34;</span><span class=p>,</span> <span class=s>&#34;products&#34;</span><span class=p>);</span>            
            <span class=kt>decimal</span> <span class=n>orderTotal</span> <span class=p>=</span> <span class=n>products</span><span class=p>.</span><span class=n>Sum</span><span class=p>(</span><span class=n>product</span> <span class=p>=&gt;</span> <span class=n>product</span><span class=p>.</span><span class=n>Price</span><span class=p>);</span>
                <span class=n>customer</span><span class=p>.</span><span class=n>Balance</span> <span class=p>+=</span> <span class=n>orderTotal</span><span class=p>;</span>            
            <span class=k>if</span> <span class=p>(</span><span class=n>orderTotal</span> <span class=p>==</span> <span class=m>0</span><span class=p>)</span>                
                <span class=k>throw</span> <span class=k>new</span> <span class=n>ArgumentOutOfRangeException</span><span class=p>(</span><span class=s>&#34;orderTotal&#34;</span><span class=p>,</span> <span class=s>&#34;Order Total should not be zero&#34;</span><span class=p>);</span>            
            <span class=k>return</span> <span class=n>orderTotal</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong>总结</strong>：微软在处理代码乃至产品的时候，很喜欢应用此重构，你如果认真看它的代码库，认真看一下WCF的设计，就不难发现了。这个重构建议大家经常使用，这会增强整个系统的稳定性和健壮性。</p><h2 id=26避免双重否定>26.避免双重否定</h2><hr><p><strong>概念</strong>：本文中的”避免双重否定”是指把代码中的双重否定语句修改成简单的肯定语句，这样即让代码可读，同时也给维护带来了方便。</p><p><strong>正文</strong>：避免双重否定重构本身非常容易实现，但我们却在太多的代码中见过因为双重否定降低了代码的可读性以致于非常让人容易误解真正意图。存在双重否定的代码具有非常大的危害性，因为这种类型的代码容易引起错误的假设，错误的假设又会导致书写出错误的维护代码，最终会导致bug产生。具 体可以看下面的代码：</p><p>如上代码中的双重否定可读性非常低，因为我们很难搞明白双重否定的正确值。要重构它也非常容易，如下是重构后的代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span>  <span class=nn>System.Collections.Generic</span><span class=p>;</span>
<span class=k>using</span>  <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.BreakMethod.After</span><span class=p>;</span>
<span class=k>namespace</span>  <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.DoubleNegative.Before</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span>  <span class=nc>Order</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=k>void</span>  <span class=n>Checkout</span><span class=p>(</span><span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>Product</span><span class=p>&gt;</span> <span class=n>products</span><span class=p>,</span> <span class=n>Customer</span>  <span class=n>customer</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=k>if</span>  <span class=p>(!</span><span class=n>customer</span><span class=p>.</span><span class=n>IsNotFlagged</span><span class=p>)</span>
            <span class=p>{</span>
                <span class=c1>// the customer account is flagged
</span><span class=c1></span>                <span class=c1>// log some errors and return
</span><span class=c1></span>                <span class=k>return</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=c1>// normal order processing
</span><span class=c1></span>        <span class=p>}</span>
    <span class=p>}</span>
    <span class=k>public</span> <span class=k>class</span>  <span class=nc>Customer</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=kt>decimal</span>  <span class=n>Balance</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
        <span class=k>public</span> <span class=kt>bool</span>  <span class=n>IsNotFlagged</span>
        <span class=p>{</span>
            <span class=k>get</span>  <span class=p>{</span> <span class=k>return</span>  <span class=n>Balance</span> <span class=p>&lt;</span> <span class=m>30</span><span class=n>m</span><span class=p>;</span> <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System.Collections.Generic</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.BreakMethod.After</span><span class=p>;</span>
<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.DoubleNegative.After</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Order</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=k>void</span> <span class=n>Checkout</span><span class=p>(</span><span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>Product</span><span class=p>&gt;</span> <span class=n>products</span><span class=p>,</span> <span class=n>Customer</span> <span class=n>customer</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>customer</span><span class=p>.</span><span class=n>IsFlagged</span><span class=p>)</span>
            <span class=p>{</span>
                <span class=c1>// the customer account is flagged
</span><span class=c1></span>                <span class=c1>// log some errors and return
</span><span class=c1></span>                <span class=k>return</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=c1>// normal order processing
</span><span class=c1></span>        <span class=p>}</span>
    <span class=p>}</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Customer</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>Balance</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
        <span class=k>public</span> <span class=kt>bool</span> <span class=n>IsFlagged</span>
        <span class=p>{</span>
            <span class=k>get</span> <span class=p>{</span> <span class=k>return</span> <span class=n>Balance</span> <span class=p>&gt;=</span> <span class=m>30</span><span class=n>m</span><span class=p>;</span> <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong>总结</strong>： ”双重否定“很容易让人产生错误的判断，也很难让人理解你的代码，所以这个重构在我们的代码中是很重要的，尤其是在判断条件很多且业务复杂的时候。</p><h2 id=27去除上帝类>27.去除上帝类</h2><hr><p><strong>概念</strong>：本文中的”去除上帝类”是指把一个看似功能很强且很难维护的类，按照职责把自己的属性或方法分派到各自的类中或分解成功能明确的类，从而去掉上帝类。</p><p><strong>正文</strong>：我们经常可以在一些原来的代码中见到一些类明确违反了SRP原则（单一原则），这些类通常以“Utils”或“Manager”后缀 结尾，但有时这些类也没有这些特征，它仅仅是多个类多个方法的组合。另一个关于上帝类的特征是通常这些类中的方法被用注释分隔为不同的分组。那么久而久之，这些类被转换为那些没有人愿意进行归并到合适类的方法的聚集地，对这些类进行重构是将类中的代码按照职责分派到各自的类中，这样就解除了上帝类，也减轻了维护的负担。</p><p>我们看到要重构上面的代码是很简单的，只要将相关的方法按职责分派到对应的类中即可，带来的好处就是这会降低代码的颗粒度并减少未来维护代码的成本。下面是重构后的代码，它将上面的代码按照职责分为了两个不同的类。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System.Collections.Generic</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>LosTechies.DaysOfRefactoring.EncapsulateCollection.After</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.BreakMethod.After</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>Customer</span> <span class=p>=</span> <span class=n>LosTechies</span><span class=p>.</span><span class=n>DaysOfRefactoring</span><span class=p>.</span><span class=n>BreakResponsibilities</span><span class=p>.</span><span class=n>After</span><span class=p>.</span><span class=n>Customer</span><span class=p>;</span>

<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.RemoveGodClasses.Before</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>CustomerService</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>CalculateOrderDiscount</span><span class=p>(</span><span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>Product</span><span class=p>&gt;</span> <span class=n>products</span><span class=p>,</span> <span class=n>Customer</span> <span class=n>customer</span><span class=p>)</span>
        <span class=p>{</span><span class=err>$$</span>
            <span class=c1>// do work
</span><span class=c1></span>        <span class=p>}</span>

        <span class=k>public</span> <span class=kt>bool</span> <span class=n>CustomerIsValid</span><span class=p>(</span><span class=n>Customer</span> <span class=n>customer</span><span class=p>,</span> <span class=n>Order</span> <span class=n>order</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=c1>// do work
</span><span class=c1></span>        <span class=p>}</span>

        <span class=k>public</span> <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=kt>string</span><span class=p>&gt;</span> <span class=n>GatherOrderErrors</span><span class=p>(</span><span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>Product</span><span class=p>&gt;</span> <span class=n>products</span><span class=p>,</span> <span class=n>Customer</span> <span class=n>customer</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=c1>// do work
</span><span class=c1></span>        <span class=p>}</span>

        <span class=k>public</span> <span class=k>void</span> <span class=n>Register</span><span class=p>(</span><span class=n>Customer</span> <span class=n>customer</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=c1>// do work
</span><span class=c1></span>        <span class=p>}</span>

        <span class=k>public</span> <span class=k>void</span> <span class=n>ForgotPassword</span><span class=p>(</span><span class=n>Customer</span> <span class=n>customer</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=c1>// do work
</span><span class=c1></span>        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System.Collections.Generic</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>LosTechies.DaysOfRefactoring.EncapsulateCollection.After</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.BreakMethod.After</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>Customer</span> <span class=p>=</span> <span class=n>LosTechies</span><span class=p>.</span><span class=n>DaysOfRefactoring</span><span class=p>.</span><span class=n>BreakResponsibilities</span><span class=p>.</span><span class=n>After</span><span class=p>.</span><span class=n>Customer</span><span class=p>;</span>

<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.RemoveGodClasses.After</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>CustomerOrderService</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>CalculateOrderDiscount</span><span class=p>(</span><span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>Product</span><span class=p>&gt;</span> <span class=n>products</span><span class=p>,</span> <span class=n>Customer</span> <span class=n>customer</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=c1>// do work
</span><span class=c1></span>        <span class=p>}</span>

        <span class=k>public</span> <span class=kt>bool</span> <span class=n>CustomerIsValid</span><span class=p>(</span><span class=n>Customer</span> <span class=n>customer</span><span class=p>,</span> <span class=n>Order</span> <span class=n>order</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=c1>// do work
</span><span class=c1></span>        <span class=p>}</span>

        <span class=k>public</span> <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=kt>string</span><span class=p>&gt;</span> <span class=n>GatherOrderErrors</span><span class=p>(</span><span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>Product</span><span class=p>&gt;</span> <span class=n>products</span><span class=p>,</span> <span class=n>Customer</span> <span class=n>customer</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=c1>// do work
</span><span class=c1></span>        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>CustomerRegistrationService</span>
    <span class=p>{</span>

        <span class=k>public</span> <span class=k>void</span> <span class=n>Register</span><span class=p>(</span><span class=n>Customer</span> <span class=n>customer</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=c1>// do work
</span><span class=c1></span>        <span class=p>}</span>

        <span class=k>public</span> <span class=k>void</span> <span class=n>ForgotPassword</span><span class=p>(</span><span class=n>Customer</span> <span class=n>customer</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=c1>// do work
</span><span class=c1></span>        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong>总结</strong>： ”去除上帝类“是我们经常容易造成的，第一是因为简便，看到有一个现成的类，大家都会喜欢把代码往里面写，最后导致越写越大，并且声明功能都有，这样即降低了可读性，也造成了维护的负担。</p><h2 id=28为布尔方法命名>28.为布尔方法命名</h2><hr><p><strong>概念</strong>：本文中的”为布尔方法命名”是指如果一个方法带有大量的bool 参数时，可以根据bool 参数的数量，提取出若干个独立的方法来简化参数。</p><p><strong>正文</strong>：我们现在要说的重构并不是普通字面意义上的重构，它有很多值得讨论的地方。当一个方法带有大量的bool 参数时，会导致方法很容易被误解并产生非预期的行为，</p><p>根据布尔型参数的数量，我们可以决定提取出若干个独立的方法来。具体代码如下：</p><p>我们可以将上面的bool参数以独立方法的形式暴露给调用端以提高代码的可读性，同时我们还需要将原来的方法改为private以限制其可访问性。显然我们关于要</p><p>提取的独立方法会有一个很大的排列组合，这是一大缺点，所以我们可以考虑引入”参数对象“重构。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>LosTechies.DaysOfRefactoring.BreakResponsibilities.After</span><span class=p>;</span>
<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.RenameBooleanMethod.Before</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>BankAccount</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=k>void</span> <span class=n>CreateAccount</span><span class=p>(</span><span class=n>Customer</span> <span class=n>customer</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>withChecking</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>withSavings</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>withStocks</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=c1>// do work
</span><span class=c1></span>        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>LosTechies.DaysOfRefactoring.BreakResponsibilities.After</span><span class=p>;</span>
<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.RenameBooleanMethod.After</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>BankAccount</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=k>void</span> <span class=n>CreateAccountWithChecking</span><span class=p>(</span><span class=n>Customer</span> <span class=n>customer</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>CreateAccount</span><span class=p>(</span><span class=n>customer</span><span class=p>,</span> <span class=k>true</span><span class=p>,</span> <span class=k>false</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=k>public</span> <span class=k>void</span> <span class=n>CreateAccountWithCheckingAndSavings</span><span class=p>(</span><span class=n>Customer</span> <span class=n>customer</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>CreateAccount</span><span class=p>(</span><span class=n>customer</span><span class=p>,</span> <span class=k>true</span><span class=p>,</span> <span class=k>true</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=k>private</span> <span class=k>void</span> <span class=n>CreateAccount</span><span class=p>(</span><span class=n>Customer</span> <span class=n>customer</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>withChecking</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>withSavings</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=c1>// do work
</span><span class=c1></span>        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong>总结</strong>： ”为布尔方法命名“这个重构在很多时候都不常用，如果用户的参数可枚举，我们一般会枚举它的值，不过使用这种重构也有好处，就是分解开来以后，方法多了，参数少了，代码维护起来方便了一些。</p><h2 id=29去除中间人对象>29.去除中间人对象</h2><hr><p><strong>概念</strong>：本文中的”去除中间人对象”是指把在中间关联而不起任何其他作用的类移除，让有关系的两个类直接进行交互。</p><p><strong>正文</strong>：有些时候在我们的代码会存在一些”幽灵类“，设计模式大师Fowler称它们为“中间人”类，“中间人”类除了调用别的对象之外不做任何事情，所以“中间人”类没有存在的必要，我们可以将它们从代码中删除，从而让交互的两个类直接关联。</p><p>如下代码所示，Consumer 类要得到AccountDataProvider 的数据，但中间介入了没起任何作用的AccountManager 类来关联，所以我们应当移除。</p><p>重构后的代码如下所示，Consumer 和AccountDataProvider 直接进行关联，这样代码就简单了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>LosTechies.DaysOfRefactoring.PullUpField.After</span><span class=p>;</span>
<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.RemoveMiddleMan.Before</span>
<span class=p>{</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Consumer</span>
    <span class=p>{</span>        
        <span class=k>public</span> <span class=n>AccountManager</span> <span class=n>AccountManager</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>        
        <span class=k>public</span> <span class=n>Consumer</span><span class=p>(</span><span class=n>AccountManager</span> <span class=n>accountManager</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>AccountManager</span> <span class=p>=</span> <span class=n>accountManager</span><span class=p>;</span>
        <span class=p>}</span>        
        <span class=k>public</span> <span class=k>void</span> <span class=n>Get</span><span class=p>(</span><span class=kt>int</span> <span class=n>id</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>Account</span> <span class=n>account</span> <span class=p>=</span> <span class=n>AccountManager</span><span class=p>.</span><span class=n>GetAccount</span><span class=p>(</span><span class=n>id</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>AccountManager</span>
    <span class=p>{</span>        
        <span class=k>public</span> <span class=n>AccountDataProvider</span> <span class=n>DataProvider</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>        
        <span class=k>public</span> <span class=n>AccountManager</span><span class=p>(</span><span class=n>AccountDataProvider</span> <span class=n>dataProvider</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>DataProvider</span> <span class=p>=</span> <span class=n>dataProvider</span><span class=p>;</span>
        <span class=p>}</span>        
        <span class=k>public</span> <span class=n>Account</span> <span class=n>GetAccount</span><span class=p>(</span><span class=kt>int</span> <span class=n>id</span><span class=p>)</span>
        <span class=p>{</span>            
             <span class=k>return</span> <span class=n>DataProvider</span><span class=p>.</span><span class=n>GetAccount</span><span class=p>(</span><span class=n>id</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>AccountDataProvider</span>
    <span class=p>{</span>        
        <span class=k>public</span> <span class=n>Account</span> <span class=n>GetAccount</span><span class=p>(</span><span class=kt>int</span> <span class=n>id</span><span class=p>)</span>
        <span class=p>{</span>            
            <span class=c1>// get account
</span><span class=c1></span>        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>LosTechies.DaysOfRefactoring.PullUpField.After</span><span class=p>;</span>
<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.RemoveMiddleMan.After</span>
<span class=p>{</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Consumer</span>
    <span class=p>{</span>        
        <span class=k>public</span> <span class=n>AccountDataProvider</span> <span class=n>AccountDataProvider</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>        
        <span class=k>public</span> <span class=n>Consumer</span><span class=p>(</span><span class=n>AccountDataProvider</span> <span class=n>dataProvider</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>AccountDataProvider</span> <span class=p>=</span> <span class=n>dataProvider</span><span class=p>;</span>
        <span class=p>}</span>        
        <span class=k>public</span> <span class=k>void</span> <span class=n>Get</span><span class=p>(</span><span class=kt>int</span> <span class=n>id</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>Account</span> <span class=n>account</span> <span class=p>=</span> <span class=n>AccountDataProvider</span><span class=p>.</span><span class=n>GetAccount</span><span class=p>(</span><span class=n>id</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>    
    <span class=k>public</span> <span class=k>class</span> <span class=nc>AccountDataProvider</span>
    <span class=p>{</span>        
        <span class=k>public</span> <span class=n>Account</span> <span class=n>GetAccount</span><span class=p>(</span><span class=kt>int</span> <span class=n>id</span><span class=p>)</span>
        <span class=p>{</span>            
            <span class=c1>// get account
</span><span class=c1></span>        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong>总结</strong>： ”去除中间人对象“很多时候都会很有作用，尤其是在误用设计模式的代码中最容易见到，设计模式中的适配器模式和代理模式等都用中间的类是两者进行关联，这是比较合理的，因为中间类做了很多事情，而对于没有任何作用的中间类应该移除。</p><h2 id=30尽快返回>30.尽快返回</h2><hr><p><strong>概念</strong>：  本文中的”尽快返回”是指把原来复杂的条件判断等语句用尽快返回的方式简化代码。</p><p><strong>正文</strong>：如首先声明的是前面讲的”分解复杂判断“，简单的来说，当你的代码中有很深的嵌套条件时，花括号就会在代码中形成一个长长的箭头。我们经常在不同的代码中看到这种情况，并且这种情况也会扰乱代码的可读性。下代码所示，HasAccess方法里面包含一些嵌套条件，如果再加一些条件或者增加复杂度，那么代码就很可能出现几个问题：1，可读性差 2，很容易出现异常 3，性能较差</p><p>那么重构上面的代码也很简单，如果有可能的话，尽量将条件判断从方法中移除，我们让代码在做处理任务之前先检查条件，如果条件不满足就尽快返回，不继续执行。</p><p>下面是重构后的代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System.Collections.Generic</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Linq</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.BreakMethod.After</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>Customer</span> <span class=p>=</span> <span class=n>LosTechies</span><span class=p>.</span><span class=n>DaysOfRefactoring</span><span class=p>.</span><span class=n>BreakResponsibilities</span><span class=p>.</span><span class=n>After</span><span class=p>.</span><span class=n>Customer</span><span class=p>;</span>

<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.ReturnASAP.Before</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Order</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=n>Customer</span> <span class=n>Customer</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>

        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>CalculateOrder</span><span class=p>(</span><span class=n>Customer</span> <span class=n>customer</span><span class=p>,</span> <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>Product</span><span class=p>&gt;</span> <span class=n>products</span><span class=p>,</span> <span class=kt>decimal</span> <span class=n>discounts</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>Customer</span> <span class=p>=</span> <span class=n>customer</span><span class=p>;</span>
            <span class=kt>decimal</span> <span class=n>orderTotal</span> <span class=p>=</span> <span class=m>0</span><span class=n>m</span><span class=p>;</span>

            <span class=k>if</span> <span class=p>(</span><span class=n>products</span><span class=p>.</span><span class=n>Count</span><span class=p>()</span> <span class=p>&gt;</span> <span class=m>0</span><span class=p>)</span>
            <span class=p>{</span>
                <span class=n>orderTotal</span> <span class=p>=</span> <span class=n>products</span><span class=p>.</span><span class=n>Sum</span><span class=p>(</span><span class=n>p</span> <span class=p>=&gt;</span> <span class=n>p</span><span class=p>.</span><span class=n>Price</span><span class=p>);</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>discounts</span> <span class=p>&gt;</span> <span class=m>0</span><span class=p>)</span>
                <span class=p>{</span>
                    <span class=n>orderTotal</span> <span class=p>-=</span> <span class=n>discounts</span><span class=p>;</span>
                <span class=p>}</span>
            <span class=p>}</span>

            <span class=k>return</span> <span class=n>orderTotal</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System.Collections.Generic</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Linq</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.BreakMethod.After</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>Customer</span> <span class=p>=</span> <span class=n>LosTechies</span><span class=p>.</span><span class=n>DaysOfRefactoring</span><span class=p>.</span><span class=n>BreakResponsibilities</span><span class=p>.</span><span class=n>After</span><span class=p>.</span><span class=n>Customer</span><span class=p>;</span>

<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.ReturnASAP.After</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>Order</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=n>Customer</span> <span class=n>Customer</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>

        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>CalculateOrder</span><span class=p>(</span><span class=n>Customer</span> <span class=n>customer</span><span class=p>,</span> <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>Product</span><span class=p>&gt;</span> <span class=n>products</span><span class=p>,</span> <span class=kt>decimal</span> <span class=n>discounts</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>products</span><span class=p>.</span><span class=n>Count</span><span class=p>()</span> <span class=p>==</span> <span class=m>0</span><span class=p>)</span>
                <span class=k>return</span> <span class=m>0</span><span class=p>;</span>

            <span class=n>Customer</span> <span class=p>=</span> <span class=n>customer</span><span class=p>;</span>
            <span class=kt>decimal</span> <span class=n>orderTotal</span> <span class=p>=</span> <span class=n>products</span><span class=p>.</span><span class=n>Sum</span><span class=p>(</span><span class=n>p</span> <span class=p>=&gt;</span> <span class=n>p</span><span class=p>.</span><span class=n>Price</span><span class=p>);</span>

            <span class=k>if</span> <span class=p>(</span><span class=n>discounts</span> <span class=p>==</span> <span class=m>0</span><span class=p>)</span>
                <span class=k>return</span> <span class=n>orderTotal</span><span class=p>;</span>

            <span class=n>orderTotal</span> <span class=p>-=</span> <span class=n>discounts</span><span class=p>;</span>

            <span class=k>return</span> <span class=n>orderTotal</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong>总结</strong>： 总结：这个重构很重要，它和前面讲的”分解复杂判断“有些类似，我们在做复杂的处理过程时，要经常考虑这个重构，用好了它，会对我们的帮助很大。</p><h2 id=31使用多态代替条件判断>31.使用多态代替条件判断</h2><hr><p><strong>概念</strong>：本文中的”使用多态代替条件判断”是指如果你需要检查对象的类型或者根据类型执行一些操作时，一种很好的办法就是将算法封装到类中，并利用多态性进行抽象调用。</p><p><strong>正文</strong>：本文展示了面向对象编程的基础之一“多态性”， 有时你需要检查对象的类型或者根据类型执行一些操作时，一种很好的办法就是将算法封装到类中，并利用多态性进行抽象调用。</p><p>如下代码所示，OrderProcessor 类的ProcessOrder方法根据Customer 的类型分别执行一些操作，正如上面所讲的那样，我们最好将OrderProcessor 类中这些算法（数据或操作）封装在特定的Customer 子类中。</p><p>重构后的代码如下，每个Customer 子类都封装自己的算法，然后OrderProcessor 类的ProcessOrder方法的逻辑也变得简单并且清晰了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Collections.Generic</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Linq</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Text</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.BreakMethod.After</span><span class=p>;</span>

<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.ReplaceWithPolymorphism.Before</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>abstract</span> <span class=k>class</span> <span class=nc>Customer</span>
    <span class=p>{</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>Employee</span> <span class=p>:</span> <span class=n>Customer</span>
    <span class=p>{</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>NonEmployee</span> <span class=p>:</span> <span class=n>Customer</span>
    <span class=p>{</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>OrderProcessor</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>ProcessOrder</span><span class=p>(</span><span class=n>Customer</span> <span class=n>customer</span><span class=p>,</span> <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>Product</span><span class=p>&gt;</span> <span class=n>products</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=c1>// do some processing of order
</span><span class=c1></span>            <span class=kt>decimal</span> <span class=n>orderTotal</span> <span class=p>=</span> <span class=n>products</span><span class=p>.</span><span class=n>Sum</span><span class=p>(</span><span class=n>p</span> <span class=p>=&gt;</span> <span class=n>p</span><span class=p>.</span><span class=n>Price</span><span class=p>);</span>

            <span class=n>Type</span> <span class=n>customerType</span> <span class=p>=</span> <span class=n>customer</span><span class=p>.</span><span class=n>GetType</span><span class=p>();</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>customerType</span> <span class=p>==</span> <span class=k>typeof</span><span class=p>(</span><span class=n>Employee</span><span class=p>))</span>
            <span class=p>{</span>
                <span class=n>orderTotal</span> <span class=p>-=</span> <span class=n>orderTotal</span> <span class=p>*</span> <span class=m>0.15</span><span class=n>m</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>customerType</span> <span class=p>==</span> <span class=k>typeof</span><span class=p>(</span><span class=n>NonEmployee</span><span class=p>))</span>
            <span class=p>{</span>
                <span class=n>orderTotal</span> <span class=p>-=</span> <span class=n>orderTotal</span> <span class=p>*</span> <span class=m>0.05</span><span class=n>m</span><span class=p>;</span>
            <span class=p>}</span>

            <span class=k>return</span> <span class=n>orderTotal</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Collections.Generic</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Linq</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Text</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.BreakMethod.After</span><span class=p>;</span>

<span class=k>namespace</span> <span class=nn>LosTechies.DaysOfRefactoring.SampleCode.ReplaceWithPolymorphism.After</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>abstract</span> <span class=k>class</span> <span class=nc>Customer</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=k>abstract</span> <span class=kt>decimal</span> <span class=n>DiscountPercentage</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>Employee</span> <span class=p>:</span> <span class=n>Customer</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=k>override</span> <span class=kt>decimal</span> <span class=n>DiscountPercentage</span>
        <span class=p>{</span>
            <span class=k>get</span> <span class=p>{</span> <span class=k>return</span> <span class=m>0.15</span><span class=n>m</span><span class=p>;</span> <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>NonEmployee</span> <span class=p>:</span> <span class=n>Customer</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=k>override</span> <span class=kt>decimal</span> <span class=n>DiscountPercentage</span>
        <span class=p>{</span>
            <span class=k>get</span> <span class=p>{</span> <span class=k>return</span> <span class=m>0.05</span><span class=n>m</span><span class=p>;</span> <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>class</span> <span class=nc>OrderProcessor</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=kt>decimal</span> <span class=n>ProcessOrder</span><span class=p>(</span><span class=n>Customer</span> <span class=n>customer</span><span class=p>,</span> <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>Product</span><span class=p>&gt;</span> <span class=n>products</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=c1>// do some processing of order
</span><span class=c1></span>            <span class=kt>decimal</span> <span class=n>orderTotal</span> <span class=p>=</span> <span class=n>products</span><span class=p>.</span><span class=n>Sum</span><span class=p>(</span><span class=n>p</span> <span class=p>=&gt;</span> <span class=n>p</span><span class=p>.</span><span class=n>Price</span><span class=p>);</span>

            <span class=n>orderTotal</span> <span class=p>-=</span> <span class=n>orderTotal</span> <span class=p>*</span> <span class=n>customer</span><span class=p>.</span><span class=n>DiscountPercentage</span><span class=p>;</span>

            <span class=k>return</span> <span class=n>orderTotal</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong>总结</strong>： ”使用多态代替条件判断“这个重构在很多时候会出现设计模式中（常见的工厂家族、策略模式等都可以看到它的影子），因为运用它可以省去很多的条件判断，同时也能简化代码、规范类和对象之间的职责。</p><blockquote><p>版权声明：本文为CSDN博主「kunlong0909」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。<br>原文链接：<a href=https://blog.csdn.net/kunlong0909/article/details/47606791>https://blog.csdn.net/kunlong0909/article/details/47606791</a></p></blockquote><hr><center>- 完 -</center><div style=text-align:center;margin-bottom:30px><h5 style=font-weight:600;margin-bottom:10px>「&nbsp;感谢支持&nbsp;」</h5><button id=rewardButton><span>赞赏</span></button><div id=QR style=display:none><div id=wechat style=display:inline-block><a class=fancybox rel=group><img id=wechat_qr src=https://cdn.jsdelivr.net/gh/Gethin1990/PicBed/BlogImg/wechatpay.jpg alt="WeChat Pay"></a><h5 style=font-weight:600;margin-top:5px>微信赞赏</h5></div><div id=alipay style=display:inline-block><a class=fancybox rel=group><img id=alipay_qr src=https://cdn.jsdelivr.net/gh/Gethin1990/PicBed/BlogImg/alipay.jpg alt=Alipay></a><h5 style=font-weight:600;margin-top:5px>支付宝赞赏</h5></div></div></div><div id=copyright-container><ul class=post-copyright><li class=post-copyright-author><strong>文章作者：</strong><a href=https://blog.gethin.online/ target=_blank>格心</a></li><li class=post-copyright-link><strong>文章链接：</strong><a href=# target=_blank title=[转载]C#重构经典全面汇总>https://blog.gethin.online/refactoring-reprinted/</a></li><li class=post-copyright-license><strong>版权声明：</strong>本站所有文章除特别声明外，均采用 <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank title="CC BY-NC-ND 4.0">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a> 转载请注明来自 <a href=https://blog.gethin.online/ target=_blank>格心</a></li></ul></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2021-09-22</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://blog.gethin.online/refactoring-reprinted/ data-title=[转载]C#重构经典全面汇总 data-hashtags=重构><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://blog.gethin.online/refactoring-reprinted/ data-hashtag=重构><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://blog.gethin.online/refactoring-reprinted/ data-title=[转载]C#重构经典全面汇总><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://blog.gethin.online/refactoring-reprinted/ data-title=[转载]C#重构经典全面汇总><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://blog.gethin.online/refactoring-reprinted/ data-title=[转载]C#重构经典全面汇总 data-image=https://cdn.jsdelivr.net/gh/Gethin1990/PicBed/BlogImg/refactoring-reprinted-2021-06-05-19-34-07.jpg><i class="fab fa-weibo fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/%E9%87%8D%E6%9E%84/>重构</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/redis-reprinted/ class=prev rel=prev title=[转载]Redis面试题><i class="fas fa-angle-left fa-fw"></i>[转载]Redis面试题</a>
<a href=/http-status-code/ class=next rel=next title="HTTP 响应代码">HTTP 响应代码<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=gitalk class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://github.com/gitalk/gitalk></a>Gitalk</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><span id=timeDate>运行 time 天&nbsp;|&nbsp;</span>
<script>var now=new Date();function createtime(){var start_time=new Date("05/05/2021 00:00:00");now.setTime(now.getTime()+250);days=(now-start_time)/1000/60/60/24;dnum=Math.floor(days);var worktime=document.getElementById("timeDate").innerHTML.replace(/time/,Math.floor(days));document.getElementById("timeDate").innerHTML=worktime;}
createtime();</script>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.74.3">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i>LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2021</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://blog.gethin.online/ target=_blank>格心</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/>知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.css><link rel=stylesheet href=/css/_custom.scss><script type=text/javascript src=https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/twemoji@13.0.0/dist/twemoji.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/mhchem.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><script type=text/javascript src=/js/jquery.backstretch.min.js></script><script type=text/javascript src=/js/dayjs.min.js></script><script type=text/javascript src=/js/custom.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{"gitalk":{"admin":["Gethin1990"],"clientID":"4743974d0c1165efbf05","clientSecret":"94543d55ec4241197bf2029c5167870e9185d619","id":"2021-06-05T00:00:00Z","owner":"Gethin1990","repo":"gsblogtalk","title":"[转载]C#重构经典全面汇总"}},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"algoliaAppID":"K8S9KF7M5S","algoliaIndex":"hugoblog_cn","algoliaSearchKey":"8ee76e5626e8145996a6c46fbdce0d23","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"},"twemoji":true};</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-FFRV57P35K',{'anonymize_ip':true});</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-FFRV57P35K" async></script><script>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?67eb34015166e2e77745ce46dd823cb7";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script></body></html>